import { MarkdownView, parseYaml } from 'obsidian';
import { DEFAULT_BLOCK_CONFIG } from '../types';
export class BlockManager {
    constructor(app) {
        // Track focus state across re-renders
        this.sessionFocus = { lineStart: null, ch: null, file: null };
        this.app = app;
    }
    parseBlock(source) {
        const trimmedSource = source.trim();
        // More robust regex to match YAML even if the prompt is empty or just whitespace
        const yamlMatch = trimmedSource.match(/^---\n([\s\S]*?)\n---(?:\n([\s\S]*)|$)/);
        let config = {
            yamlConfig: { ...DEFAULT_BLOCK_CONFIG },
            prompt: trimmedSource,
            hasYaml: false
        };
        if (yamlMatch) {
            config.hasYaml = true;
            try {
                const parsedYaml = parseYaml(yamlMatch[1]);
                config.yamlConfig = { ...DEFAULT_BLOCK_CONFIG, ...parsedYaml };
                config.prompt = (yamlMatch[2] || '').trim();
            }
            catch (error) {
                console.error('Error parsing YAML:', error);
                // If parsing fails, we treat the whole thing as prompt
                config.hasYaml = false;
            }
        }
        return config;
    }
    validateConfig(config) {
        const errors = [];
        const ranges = {
            temperature: [0, 2],
            max_tokens: [1, 20000],
            top_p: [0, 1],
            frequency_penalty: [0, 2],
            presence_penalty: [0, 2],
            num_responses: [1, 20]
        };
        for (const [key, range] of Object.entries(ranges)) {
            if (config[key] !== undefined && (config[key] < range[0] || config[key] > range[1])) {
                errors.push(`${key} must be between ${range[0]} and ${range[1]}`);
            }
        }
        return errors;
    }
    async updateFileBlock(el, ctx, newPrompt, newYaml) {
        const sectionInfo = ctx.getSectionInfo(el);
        if (!sectionInfo)
            throw new Error('Could not get section info');
        const view = this.app.workspace.getActiveViewOfType(MarkdownView);
        if (!view)
            throw new Error('No active markdown view');
        const editor = view.editor;
        const { lineStart, lineEnd } = sectionInfo;
        const updatedBlockContent = newYaml ? `---\n${newYaml}\n---\n${newPrompt}` : newPrompt;
        const startPos = { line: lineStart + 1, ch: 0 };
        const endPos = { line: lineEnd, ch: 0 };
        editor.replaceRange(updatedBlockContent + '\n', startPos, endPos);
        // Notice removed as it interrupts typing flow
    }
    generateYamlFromConfig(config) {
        const lines = [];
        const default_config = DEFAULT_BLOCK_CONFIG;
        for (const key in default_config) {
            if (config[key] !== undefined && config[key] !== default_config[key]) {
                const value = config[key];
                if (Array.isArray(value)) {
                    lines.push(`${key}: ${JSON.stringify(value)}`);
                }
                else if (typeof value === 'string') {
                    // Quote strings especially if they contain colons or other potential special chars
                    if (value.includes(':') || value.includes('#') || value === '') {
                        lines.push(`${key}: "${value}"`);
                    }
                    else {
                        lines.push(`${key}: ${value}`);
                    }
                }
                else {
                    lines.push(`${key}: ${value}`);
                }
            }
        }
        return lines.length > 0 ? lines.join('\n') : '';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmxvY2tNYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQmxvY2tNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBZSxZQUFZLEVBQWdDLFNBQVMsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUM5RixPQUFPLEVBQW9CLG9CQUFvQixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRWxFLE1BQU0sT0FBTyxZQUFZO0lBU3JCLFlBQVksR0FBUTtRQVBwQixzQ0FBc0M7UUFDL0IsaUJBQVksR0FJZixFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFHMUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7SUFDbkIsQ0FBQztJQUVELFVBQVUsQ0FBQyxNQUFjO1FBQ3JCLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNwQyxpRkFBaUY7UUFDakYsTUFBTSxTQUFTLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDO1FBRWhGLElBQUksTUFBTSxHQUFxQjtZQUMzQixVQUFVLEVBQUUsRUFBRSxHQUFHLG9CQUFvQixFQUFFO1lBQ3ZDLE1BQU0sRUFBRSxhQUFhO1lBQ3JCLE9BQU8sRUFBRSxLQUFLO1NBQ2pCLENBQUM7UUFFRixJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQ1osTUFBTSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7WUFDdEIsSUFBSSxDQUFDO2dCQUNELE1BQU0sVUFBVSxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDM0MsTUFBTSxDQUFDLFVBQVUsR0FBRyxFQUFFLEdBQUcsb0JBQW9CLEVBQUUsR0FBRyxVQUFVLEVBQUUsQ0FBQztnQkFDL0QsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNoRCxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDYixPQUFPLENBQUMsS0FBSyxDQUFDLHFCQUFxQixFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUM1Qyx1REFBdUQ7Z0JBQ3ZELE1BQU0sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1lBQzNCLENBQUM7UUFDTCxDQUFDO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVELGNBQWMsQ0FBQyxNQUFXO1FBQ3RCLE1BQU0sTUFBTSxHQUFhLEVBQUUsQ0FBQztRQUM1QixNQUFNLE1BQU0sR0FBRztZQUNYLFdBQVcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDbkIsVUFBVSxFQUFFLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQztZQUN0QixLQUFLLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2IsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3pCLGdCQUFnQixFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN4QixhQUFhLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDO1NBQ3pCLENBQUM7UUFFRixLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1lBQ2hELElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7Z0JBQ2xGLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLG9CQUFvQixLQUFLLENBQUMsQ0FBQyxDQUFDLFFBQVEsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN0RSxDQUFDO1FBQ0wsQ0FBQztRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZSxDQUFDLEVBQWUsRUFBRSxHQUFpQyxFQUFFLFNBQWlCLEVBQUUsT0FBZTtRQUN4RyxNQUFNLFdBQVcsR0FBRyxHQUFHLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLElBQUksQ0FBQyxXQUFXO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO1FBRWhFLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ2xFLElBQUksQ0FBQyxJQUFJO1lBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1FBRXRELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDM0IsTUFBTSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsR0FBRyxXQUFXLENBQUM7UUFFM0MsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLFFBQVEsT0FBTyxVQUFVLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFFdkYsTUFBTSxRQUFRLEdBQUcsRUFBRSxJQUFJLEVBQUUsU0FBUyxHQUFHLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFDaEQsTUFBTSxNQUFNLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUV4QyxNQUFNLENBQUMsWUFBWSxDQUFDLG1CQUFtQixHQUFHLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDbEUsOENBQThDO0lBQ2xELENBQUM7SUFFRCxzQkFBc0IsQ0FBQyxNQUFXO1FBQzlCLE1BQU0sS0FBSyxHQUFhLEVBQUUsQ0FBQztRQUMzQixNQUFNLGNBQWMsR0FBUSxvQkFBb0IsQ0FBQztRQUVqRCxLQUFLLE1BQU0sR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDO1lBQy9CLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssY0FBYyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ25FLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDMUIsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7b0JBQ3ZCLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLEtBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ25ELENBQUM7cUJBQU0sSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUUsQ0FBQztvQkFDbkMsbUZBQW1GO29CQUNuRixJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLEtBQUssRUFBRSxFQUFFLENBQUM7d0JBQzdELEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLE1BQU0sS0FBSyxHQUFHLENBQUMsQ0FBQztvQkFDckMsQ0FBQzt5QkFBTSxDQUFDO3dCQUNKLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLEtBQUssS0FBSyxFQUFFLENBQUMsQ0FBQztvQkFDbkMsQ0FBQztnQkFDTCxDQUFDO3FCQUFNLENBQUM7b0JBQ0osS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxLQUFLLEVBQUUsQ0FBQyxDQUFDO2dCQUNuQyxDQUFDO1lBQ0wsQ0FBQztRQUNMLENBQUM7UUFFRCxPQUFPLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDcEQsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBOb3RpY2UsIE1hcmtkb3duVmlldywgTWFya2Rvd25Qb3N0UHJvY2Vzc29yQ29udGV4dCwgcGFyc2VZYW1sIH0gZnJvbSAnb2JzaWRpYW4nO1xuaW1wb3J0IHsgTExNQmxvY2tTZXR0aW5ncywgREVGQVVMVF9CTE9DS19DT05GSUcgfSBmcm9tICcuLi90eXBlcyc7XG5cbmV4cG9ydCBjbGFzcyBCbG9ja01hbmFnZXIge1xuICAgIHByaXZhdGUgYXBwOiBBcHA7XG4gICAgLy8gVHJhY2sgZm9jdXMgc3RhdGUgYWNyb3NzIHJlLXJlbmRlcnNcbiAgICBwdWJsaWMgc2Vzc2lvbkZvY3VzOiB7XG4gICAgICAgIGxpbmVTdGFydDogbnVtYmVyIHwgbnVsbCxcbiAgICAgICAgY2g6IG51bWJlciB8IG51bGwsXG4gICAgICAgIGZpbGU6IHN0cmluZyB8IG51bGxcbiAgICB9ID0geyBsaW5lU3RhcnQ6IG51bGwsIGNoOiBudWxsLCBmaWxlOiBudWxsIH07XG5cbiAgICBjb25zdHJ1Y3RvcihhcHA6IEFwcCkge1xuICAgICAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICB9XG5cbiAgICBwYXJzZUJsb2NrKHNvdXJjZTogc3RyaW5nKTogTExNQmxvY2tTZXR0aW5ncyB7XG4gICAgICAgIGNvbnN0IHRyaW1tZWRTb3VyY2UgPSBzb3VyY2UudHJpbSgpO1xuICAgICAgICAvLyBNb3JlIHJvYnVzdCByZWdleCB0byBtYXRjaCBZQU1MIGV2ZW4gaWYgdGhlIHByb21wdCBpcyBlbXB0eSBvciBqdXN0IHdoaXRlc3BhY2VcbiAgICAgICAgY29uc3QgeWFtbE1hdGNoID0gdHJpbW1lZFNvdXJjZS5tYXRjaCgvXi0tLVxcbihbXFxzXFxTXSo/KVxcbi0tLSg/OlxcbihbXFxzXFxTXSopfCQpLyk7XG5cbiAgICAgICAgbGV0IGNvbmZpZzogTExNQmxvY2tTZXR0aW5ncyA9IHtcbiAgICAgICAgICAgIHlhbWxDb25maWc6IHsgLi4uREVGQVVMVF9CTE9DS19DT05GSUcgfSxcbiAgICAgICAgICAgIHByb21wdDogdHJpbW1lZFNvdXJjZSxcbiAgICAgICAgICAgIGhhc1lhbWw6IGZhbHNlXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKHlhbWxNYXRjaCkge1xuICAgICAgICAgICAgY29uZmlnLmhhc1lhbWwgPSB0cnVlO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJzZWRZYW1sID0gcGFyc2VZYW1sKHlhbWxNYXRjaFsxXSk7XG4gICAgICAgICAgICAgICAgY29uZmlnLnlhbWxDb25maWcgPSB7IC4uLkRFRkFVTFRfQkxPQ0tfQ09ORklHLCAuLi5wYXJzZWRZYW1sIH07XG4gICAgICAgICAgICAgICAgY29uZmlnLnByb21wdCA9ICh5YW1sTWF0Y2hbMl0gfHwgJycpLnRyaW0oKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgcGFyc2luZyBZQU1MOicsIGVycm9yKTtcbiAgICAgICAgICAgICAgICAvLyBJZiBwYXJzaW5nIGZhaWxzLCB3ZSB0cmVhdCB0aGUgd2hvbGUgdGhpbmcgYXMgcHJvbXB0XG4gICAgICAgICAgICAgICAgY29uZmlnLmhhc1lhbWwgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjb25maWc7XG4gICAgfVxuXG4gICAgdmFsaWRhdGVDb25maWcoY29uZmlnOiBhbnkpOiBzdHJpbmdbXSB7XG4gICAgICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgY29uc3QgcmFuZ2VzID0ge1xuICAgICAgICAgICAgdGVtcGVyYXR1cmU6IFswLCAyXSxcbiAgICAgICAgICAgIG1heF90b2tlbnM6IFsxLCAyMDAwMF0sXG4gICAgICAgICAgICB0b3BfcDogWzAsIDFdLFxuICAgICAgICAgICAgZnJlcXVlbmN5X3BlbmFsdHk6IFswLCAyXSxcbiAgICAgICAgICAgIHByZXNlbmNlX3BlbmFsdHk6IFswLCAyXSxcbiAgICAgICAgICAgIG51bV9yZXNwb25zZXM6IFsxLCAyMF1cbiAgICAgICAgfTtcblxuICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHJhbmdlXSBvZiBPYmplY3QuZW50cmllcyhyYW5nZXMpKSB7XG4gICAgICAgICAgICBpZiAoY29uZmlnW2tleV0gIT09IHVuZGVmaW5lZCAmJiAoY29uZmlnW2tleV0gPCByYW5nZVswXSB8fCBjb25maWdba2V5XSA+IHJhbmdlWzFdKSkge1xuICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKGAke2tleX0gbXVzdCBiZSBiZXR3ZWVuICR7cmFuZ2VbMF19IGFuZCAke3JhbmdlWzFdfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVycm9ycztcbiAgICB9XG5cbiAgICBhc3luYyB1cGRhdGVGaWxlQmxvY2soZWw6IEhUTUxFbGVtZW50LCBjdHg6IE1hcmtkb3duUG9zdFByb2Nlc3NvckNvbnRleHQsIG5ld1Byb21wdDogc3RyaW5nLCBuZXdZYW1sOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3Qgc2VjdGlvbkluZm8gPSBjdHguZ2V0U2VjdGlvbkluZm8oZWwpO1xuICAgICAgICBpZiAoIXNlY3Rpb25JbmZvKSB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBnZXQgc2VjdGlvbiBpbmZvJyk7XG5cbiAgICAgICAgY29uc3QgdmlldyA9IHRoaXMuYXBwLndvcmtzcGFjZS5nZXRBY3RpdmVWaWV3T2ZUeXBlKE1hcmtkb3duVmlldyk7XG4gICAgICAgIGlmICghdmlldykgdGhyb3cgbmV3IEVycm9yKCdObyBhY3RpdmUgbWFya2Rvd24gdmlldycpO1xuXG4gICAgICAgIGNvbnN0IGVkaXRvciA9IHZpZXcuZWRpdG9yO1xuICAgICAgICBjb25zdCB7IGxpbmVTdGFydCwgbGluZUVuZCB9ID0gc2VjdGlvbkluZm87XG5cbiAgICAgICAgY29uc3QgdXBkYXRlZEJsb2NrQ29udGVudCA9IG5ld1lhbWwgPyBgLS0tXFxuJHtuZXdZYW1sfVxcbi0tLVxcbiR7bmV3UHJvbXB0fWAgOiBuZXdQcm9tcHQ7XG5cbiAgICAgICAgY29uc3Qgc3RhcnRQb3MgPSB7IGxpbmU6IGxpbmVTdGFydCArIDEsIGNoOiAwIH07XG4gICAgICAgIGNvbnN0IGVuZFBvcyA9IHsgbGluZTogbGluZUVuZCwgY2g6IDAgfTtcblxuICAgICAgICBlZGl0b3IucmVwbGFjZVJhbmdlKHVwZGF0ZWRCbG9ja0NvbnRlbnQgKyAnXFxuJywgc3RhcnRQb3MsIGVuZFBvcyk7XG4gICAgICAgIC8vIE5vdGljZSByZW1vdmVkIGFzIGl0IGludGVycnVwdHMgdHlwaW5nIGZsb3dcbiAgICB9XG5cbiAgICBnZW5lcmF0ZVlhbWxGcm9tQ29uZmlnKGNvbmZpZzogYW55KTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgbGluZXM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGNvbnN0IGRlZmF1bHRfY29uZmlnOiBhbnkgPSBERUZBVUxUX0JMT0NLX0NPTkZJRztcblxuICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBkZWZhdWx0X2NvbmZpZykge1xuICAgICAgICAgICAgaWYgKGNvbmZpZ1trZXldICE9PSB1bmRlZmluZWQgJiYgY29uZmlnW2tleV0gIT09IGRlZmF1bHRfY29uZmlnW2tleV0pIHtcbiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGNvbmZpZ1trZXldO1xuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICBsaW5lcy5wdXNoKGAke2tleX06ICR7SlNPTi5zdHJpbmdpZnkodmFsdWUpfWApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBRdW90ZSBzdHJpbmdzIGVzcGVjaWFsbHkgaWYgdGhleSBjb250YWluIGNvbG9ucyBvciBvdGhlciBwb3RlbnRpYWwgc3BlY2lhbCBjaGFyc1xuICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUuaW5jbHVkZXMoJzonKSB8fCB2YWx1ZS5pbmNsdWRlcygnIycpIHx8IHZhbHVlID09PSAnJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMucHVzaChgJHtrZXl9OiBcIiR7dmFsdWV9XCJgKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzLnB1c2goYCR7a2V5fTogJHt2YWx1ZX1gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxpbmVzLnB1c2goYCR7a2V5fTogJHt2YWx1ZX1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbGluZXMubGVuZ3RoID4gMCA/IGxpbmVzLmpvaW4oJ1xcbicpIDogJyc7XG4gICAgfVxufVxuIl19