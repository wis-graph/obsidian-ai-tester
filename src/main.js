import { Plugin } from 'obsidian';
import { DEFAULT_SETTINGS } from './types';
import { LLMService } from './services/LLMService';
import { BlockManager } from './logic/BlockManager';
import { OllamaBlockView } from './ui/OllamaBlockView';
import { LLMSettingTab } from './settings/SettingsTab';
export default class AITesterPlugin extends Plugin {
    constructor() {
        super(...arguments);
        this.settings = DEFAULT_SETTINGS;
    }
    async onload() {
        console.log('AI Tester plugin loading...');
        await this.loadSettings();
        this.llmService = new LLMService(this.settings);
        this.blockManager = new BlockManager(this.app);
        this.addSettingTab(new LLMSettingTab(this.app, this));
        this.registerMarkdownCodeBlockProcessor('ai-tester', (source, el, ctx) => {
            const blockSettings = this.blockManager.parseBlock(source);
            const view = new OllamaBlockView(el, this.llmService, this.blockManager, ctx, blockSettings);
            view.render();
        });
    }
    async onunload() {
        console.log('AI Tester plugin unloaded');
    }
    async loadSettings() {
        var _a, _b;
        const loadedData = await this.loadData();
        this.settings = Object.assign({}, DEFAULT_SETTINGS, loadedData);
        // Migration: Move top-level model/serverUrl if they exist
        if (loadedData && (loadedData.model || loadedData.serverUrl)) {
            if (loadedData.model && !((_a = loadedData.ollama) === null || _a === void 0 ? void 0 : _a.model)) {
                this.settings.ollama.model = loadedData.model;
            }
            if (loadedData.serverUrl && !((_b = loadedData.ollama) === null || _b === void 0 ? void 0 : _b.serverUrl)) {
                this.settings.ollama.serverUrl = loadedData.serverUrl;
            }
            // Clean up top level and save immediately
            await this.saveSettings();
        }
    }
    async saveSettings() {
        // Only save keys that are in DEFAULT_SETTINGS
        const sanitizedSettings = {};
        const validKeys = Object.keys(DEFAULT_SETTINGS);
        validKeys.forEach(key => {
            sanitizedSettings[key] = this.settings[key];
        });
        await this.saveData(sanitizedSettings);
        this.llmService.updateSettings(this.settings);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNsQyxPQUFPLEVBQWUsZ0JBQWdCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ25ELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRXZELE1BQU0sQ0FBQyxPQUFPLE9BQU8sY0FBZSxTQUFRLE1BQU07SUFBbEQ7O1FBQ0MsYUFBUSxHQUFnQixnQkFBZ0IsQ0FBQztJQXVEMUMsQ0FBQztJQW5EQSxLQUFLLENBQUMsTUFBTTtRQUNYLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkJBQTZCLENBQUMsQ0FBQztRQUUzQyxNQUFNLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUUxQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUUvQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUV0RCxJQUFJLENBQUMsa0NBQWtDLENBQUMsV0FBVyxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUN4RSxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMzRCxNQUFNLElBQUksR0FBRyxJQUFJLGVBQWUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRSxhQUFhLENBQUMsQ0FBQztZQUM3RixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDZixDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsUUFBUTtRQUNiLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkJBQTJCLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVk7O1FBQ2pCLE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsZ0JBQWdCLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFaEUsMERBQTBEO1FBQzFELElBQUksVUFBVSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssSUFBSSxVQUFVLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztZQUM5RCxJQUFJLFVBQVUsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFBLE1BQUEsVUFBVSxDQUFDLE1BQU0sMENBQUUsS0FBSyxDQUFBLEVBQUUsQ0FBQztnQkFDbkQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUM7WUFDL0MsQ0FBQztZQUNELElBQUksVUFBVSxDQUFDLFNBQVMsSUFBSSxDQUFDLENBQUEsTUFBQSxVQUFVLENBQUMsTUFBTSwwQ0FBRSxTQUFTLENBQUEsRUFBRSxDQUFDO2dCQUMzRCxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQztZQUN2RCxDQUFDO1lBRUQsMENBQTBDO1lBQzFDLE1BQU0sSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzNCLENBQUM7SUFDRixDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVk7UUFDakIsOENBQThDO1FBQzlDLE1BQU0saUJBQWlCLEdBQVEsRUFBRSxDQUFDO1FBQ2xDLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQTBCLENBQUM7UUFFekUsU0FBUyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUN2QixpQkFBaUIsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzdDLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQy9DLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBsdWdpbiB9IGZyb20gJ29ic2lkaWFuJztcbmltcG9ydCB7IExMTVNldHRpbmdzLCBERUZBVUxUX1NFVFRJTkdTIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBMTE1TZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9MTE1TZXJ2aWNlJztcbmltcG9ydCB7IEJsb2NrTWFuYWdlciB9IGZyb20gJy4vbG9naWMvQmxvY2tNYW5hZ2VyJztcbmltcG9ydCB7IE9sbGFtYUJsb2NrVmlldyB9IGZyb20gJy4vdWkvT2xsYW1hQmxvY2tWaWV3JztcbmltcG9ydCB7IExMTVNldHRpbmdUYWIgfSBmcm9tICcuL3NldHRpbmdzL1NldHRpbmdzVGFiJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQUlUZXN0ZXJQbHVnaW4gZXh0ZW5kcyBQbHVnaW4ge1xuXHRzZXR0aW5nczogTExNU2V0dGluZ3MgPSBERUZBVUxUX1NFVFRJTkdTO1xuXHRsbG1TZXJ2aWNlOiBMTE1TZXJ2aWNlO1xuXHRibG9ja01hbmFnZXI6IEJsb2NrTWFuYWdlcjtcblxuXHRhc3luYyBvbmxvYWQoKSB7XG5cdFx0Y29uc29sZS5sb2coJ0FJIFRlc3RlciBwbHVnaW4gbG9hZGluZy4uLicpO1xuXG5cdFx0YXdhaXQgdGhpcy5sb2FkU2V0dGluZ3MoKTtcblxuXHRcdHRoaXMubGxtU2VydmljZSA9IG5ldyBMTE1TZXJ2aWNlKHRoaXMuc2V0dGluZ3MpO1xuXHRcdHRoaXMuYmxvY2tNYW5hZ2VyID0gbmV3IEJsb2NrTWFuYWdlcih0aGlzLmFwcCk7XG5cblx0XHR0aGlzLmFkZFNldHRpbmdUYWIobmV3IExMTVNldHRpbmdUYWIodGhpcy5hcHAsIHRoaXMpKTtcblxuXHRcdHRoaXMucmVnaXN0ZXJNYXJrZG93bkNvZGVCbG9ja1Byb2Nlc3NvcignYWktdGVzdGVyJywgKHNvdXJjZSwgZWwsIGN0eCkgPT4ge1xuXHRcdFx0Y29uc3QgYmxvY2tTZXR0aW5ncyA9IHRoaXMuYmxvY2tNYW5hZ2VyLnBhcnNlQmxvY2soc291cmNlKTtcblx0XHRcdGNvbnN0IHZpZXcgPSBuZXcgT2xsYW1hQmxvY2tWaWV3KGVsLCB0aGlzLmxsbVNlcnZpY2UsIHRoaXMuYmxvY2tNYW5hZ2VyLCBjdHgsIGJsb2NrU2V0dGluZ3MpO1xuXHRcdFx0dmlldy5yZW5kZXIoKTtcblx0XHR9KTtcblx0fVxuXG5cdGFzeW5jIG9udW5sb2FkKCkge1xuXHRcdGNvbnNvbGUubG9nKCdBSSBUZXN0ZXIgcGx1Z2luIHVubG9hZGVkJyk7XG5cdH1cblxuXHRhc3luYyBsb2FkU2V0dGluZ3MoKSB7XG5cdFx0Y29uc3QgbG9hZGVkRGF0YSA9IGF3YWl0IHRoaXMubG9hZERhdGEoKTtcblx0XHR0aGlzLnNldHRpbmdzID0gT2JqZWN0LmFzc2lnbih7fSwgREVGQVVMVF9TRVRUSU5HUywgbG9hZGVkRGF0YSk7XG5cblx0XHQvLyBNaWdyYXRpb246IE1vdmUgdG9wLWxldmVsIG1vZGVsL3NlcnZlclVybCBpZiB0aGV5IGV4aXN0XG5cdFx0aWYgKGxvYWRlZERhdGEgJiYgKGxvYWRlZERhdGEubW9kZWwgfHwgbG9hZGVkRGF0YS5zZXJ2ZXJVcmwpKSB7XG5cdFx0XHRpZiAobG9hZGVkRGF0YS5tb2RlbCAmJiAhbG9hZGVkRGF0YS5vbGxhbWE/Lm1vZGVsKSB7XG5cdFx0XHRcdHRoaXMuc2V0dGluZ3Mub2xsYW1hLm1vZGVsID0gbG9hZGVkRGF0YS5tb2RlbDtcblx0XHRcdH1cblx0XHRcdGlmIChsb2FkZWREYXRhLnNlcnZlclVybCAmJiAhbG9hZGVkRGF0YS5vbGxhbWE/LnNlcnZlclVybCkge1xuXHRcdFx0XHR0aGlzLnNldHRpbmdzLm9sbGFtYS5zZXJ2ZXJVcmwgPSBsb2FkZWREYXRhLnNlcnZlclVybDtcblx0XHRcdH1cblxuXHRcdFx0Ly8gQ2xlYW4gdXAgdG9wIGxldmVsIGFuZCBzYXZlIGltbWVkaWF0ZWx5XG5cdFx0XHRhd2FpdCB0aGlzLnNhdmVTZXR0aW5ncygpO1xuXHRcdH1cblx0fVxuXG5cdGFzeW5jIHNhdmVTZXR0aW5ncygpIHtcblx0XHQvLyBPbmx5IHNhdmUga2V5cyB0aGF0IGFyZSBpbiBERUZBVUxUX1NFVFRJTkdTXG5cdFx0Y29uc3Qgc2FuaXRpemVkU2V0dGluZ3M6IGFueSA9IHt9O1xuXHRcdGNvbnN0IHZhbGlkS2V5cyA9IE9iamVjdC5rZXlzKERFRkFVTFRfU0VUVElOR1MpIGFzIChrZXlvZiBMTE1TZXR0aW5ncylbXTtcblxuXHRcdHZhbGlkS2V5cy5mb3JFYWNoKGtleSA9PiB7XG5cdFx0XHRzYW5pdGl6ZWRTZXR0aW5nc1trZXldID0gdGhpcy5zZXR0aW5nc1trZXldO1xuXHRcdH0pO1xuXG5cdFx0YXdhaXQgdGhpcy5zYXZlRGF0YShzYW5pdGl6ZWRTZXR0aW5ncyk7XG5cdFx0dGhpcy5sbG1TZXJ2aWNlLnVwZGF0ZVNldHRpbmdzKHRoaXMuc2V0dGluZ3MpO1xuXHR9XG59XG5cbiJdfQ==