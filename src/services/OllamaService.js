import { requestUrl } from 'obsidian';
export class OllamaServiceImpl {
    constructor(settings) {
        this.modelsCache = null;
        this.settings = settings;
    }
    async fetchModels() {
        if (this.modelsCache)
            return this.modelsCache;
        try {
            const response = await requestUrl({
                url: `${this.settings.serverUrl}/api/tags`,
                method: 'GET'
            });
            if (response.status !== 200) {
                throw new Error(`Failed to fetch models: ${response.status}`);
            }
            this.modelsCache = response.json;
            return this.modelsCache;
        }
        catch (error) {
            console.error('Error fetching models:', error);
            throw error;
        }
    }
    clearCache() {
        this.modelsCache = null;
    }
    getSettings() {
        return this.settings;
    }
    async streamOllamaResponse(prompt, model, yamlConfig, abortController, onChunk, onDone) {
        var _a;
        const requestBody = {
            model,
            prompt,
            stream: true,
            options: {
                temperature: yamlConfig.temperature,
                num_predict: yamlConfig.max_tokens,
                stop: yamlConfig.stop_sequences,
                top_p: yamlConfig.top_p,
                frequency_penalty: yamlConfig.frequency_penalty,
                presence_penalty: yamlConfig.presence_penalty
            }
        };
        // Clean up undefined options
        Object.keys(requestBody.options).forEach(key => requestBody.options[key] === undefined && delete requestBody.options[key]);
        const response = await fetch(`${this.settings.serverUrl}/api/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody),
            signal: abortController.signal
        });
        if (!response.ok) {
            throw new Error(`Ollama API error: ${response.status}`);
        }
        const reader = (_a = response.body) === null || _a === void 0 ? void 0 : _a.getReader();
        if (!reader)
            throw new Error('Failed to read response body');
        const decoder = new TextDecoder();
        let buffer = '';
        while (true) {
            const { done, value } = await reader.read();
            if (done)
                break;
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            for (const line of lines) {
                if (line.trim() === '')
                    continue;
                try {
                    const data = JSON.parse(line);
                    if (data.response)
                        onChunk(data.response);
                    if (data.done)
                        onDone(data);
                }
                catch (e) {
                    console.error('Error parsing JSON line:', line, e);
                }
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2xsYW1hU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIk9sbGFtYVNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQWlCdEMsTUFBTSxPQUFPLGlCQUFpQjtJQUkxQixZQUFZLFFBQXdCO1FBRjVCLGdCQUFXLEdBQThCLElBQUksQ0FBQztRQUdsRCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUM3QixDQUFDO0lBRUQsS0FBSyxDQUFDLFdBQVc7UUFDYixJQUFJLElBQUksQ0FBQyxXQUFXO1lBQUUsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBRTlDLElBQUksQ0FBQztZQUNELE1BQU0sUUFBUSxHQUFHLE1BQU0sVUFBVSxDQUFDO2dCQUM5QixHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsV0FBVztnQkFDMUMsTUFBTSxFQUFFLEtBQUs7YUFDaEIsQ0FBQyxDQUFDO1lBRUgsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO2dCQUMxQixNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUNsRSxDQUFDO1lBRUQsSUFBSSxDQUFDLFdBQVcsR0FBRyxRQUFRLENBQUMsSUFBMEIsQ0FBQztZQUN2RCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDNUIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQy9DLE1BQU0sS0FBSyxDQUFDO1FBQ2hCLENBQUM7SUFDTCxDQUFDO0lBRUQsVUFBVTtRQUNOLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO0lBQzVCLENBQUM7SUFFRCxXQUFXO1FBQ1AsT0FBTyxJQUFJLENBQUMsUUFBUSxD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QUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDdkQsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVxdWVzdFVybCB9IGZyb20gJ29ic2lkaWFuJztcbmltcG9ydCB7IE9sbGFtYVNldHRpbmdzLCBPbGxhbWFMaXN0UmVzcG9uc2UsIE9sbGFtYUdlbmVyYXRlUmVzcG9uc2UsIE9sbGFtYUJsb2NrU2V0dGluZ3MgfSBmcm9tICcuLi90eXBlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgT2xsYW1hU2VydmljZSB7XG4gICAgZmV0Y2hNb2RlbHMoKTogUHJvbWlzZTxPbGxhbWFMaXN0UmVzcG9uc2U+O1xuICAgIGNsZWFyQ2FjaGUoKTogdm9pZDtcbiAgICBnZXRTZXR0aW5ncygpOiBPbGxhbWFTZXR0aW5ncztcbiAgICBzdHJlYW1PbGxhbWFSZXNwb25zZShcbiAgICAgICAgcHJvbXB0OiBzdHJpbmcsXG4gICAgICAgIG1vZGVsOiBzdHJpbmcsXG4gICAgICAgIHlhbWxDb25maWc6IE9sbGFtYUJsb2NrU2V0dGluZ3NbJ3lhbWxDb25maWcnXSxcbiAgICAgICAgYWJvcnRDb250cm9sbGVyOiBBYm9ydENvbnRyb2xsZXIsXG4gICAgICAgIG9uQ2h1bms6IChjaHVuazogc3RyaW5nKSA9PiB2b2lkLFxuICAgICAgICBvbkRvbmU6IChmaW5hbERhdGE6IE9sbGFtYUdlbmVyYXRlUmVzcG9uc2UpID0+IHZvaWRcbiAgICApOiBQcm9taXNlPHZvaWQ+O1xufVxuXG5leHBvcnQgY2xhc3MgT2xsYW1hU2VydmljZUltcGwgaW1wbGVtZW50cyBPbGxhbWFTZXJ2aWNlIHtcbiAgICBwcml2YXRlIHNldHRpbmdzOiBPbGxhbWFTZXR0aW5ncztcbiAgICBwcml2YXRlIG1vZGVsc0NhY2hlOiBPbGxhbWFMaXN0UmVzcG9uc2UgfCBudWxsID0gbnVsbDtcblxuICAgIGNvbnN0cnVjdG9yKHNldHRpbmdzOiBPbGxhbWFTZXR0aW5ncykge1xuICAgICAgICB0aGlzLnNldHRpbmdzID0gc2V0dGluZ3M7XG4gICAgfVxuXG4gICAgYXN5bmMgZmV0Y2hNb2RlbHMoKTogUHJvbWlzZTxPbGxhbWFMaXN0UmVzcG9uc2U+IHtcbiAgICAgICAgaWYgKHRoaXMubW9kZWxzQ2FjaGUpIHJldHVybiB0aGlzLm1vZGVsc0NhY2hlO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3RVcmwoe1xuICAgICAgICAgICAgICAgIHVybDogYCR7dGhpcy5zZXR0aW5ncy5zZXJ2ZXJVcmx9L2FwaS90YWdzYCxcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdHRVQnXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZmV0Y2ggbW9kZWxzOiAke3Jlc3BvbnNlLnN0YXR1c31gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5tb2RlbHNDYWNoZSA9IHJlc3BvbnNlLmpzb24gYXMgT2xsYW1hTGlzdFJlc3BvbnNlO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubW9kZWxzQ2FjaGU7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyBtb2RlbHM6JywgZXJyb3IpO1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjbGVhckNhY2hlKCkge1xuICAgICAgICB0aGlzLm1vZGVsc0NhY2hlID0gbnVsbDtcbiAgICB9XG5cbiAgICBnZXRTZXR0aW5ncygpOiBPbGxhbWFTZXR0aW5ncyB7XG4gICAgICAgIHJldHVybiB0aGlzLnNldHRpbmdzO1xuICAgIH1cblxuICAgIGFzeW5jIHN0cmVhbU9sbGFtYVJlc3BvbnNlKFxuICAgICAgICBwcm9tcHQ6IHN0cmluZyxcbiAgICAgICAgbW9kZWw6IHN0cmluZyxcbiAgICAgICAgeWFtbENvbmZpZzogT2xsYW1hQmxvY2tTZXR0aW5nc1sneWFtbENvbmZpZyddLFxuICAgICAgICBhYm9ydENvbnRyb2xsZXI6IEFib3J0Q29udHJvbGxlcixcbiAgICAgICAgb25DaHVuazogKGNodW5rOiBzdHJpbmcpID0+IHZvaWQsXG4gICAgICAgIG9uRG9uZTogKGZpbmFsRGF0YTogT2xsYW1hR2VuZXJhdGVSZXNwb25zZSkgPT4gdm9pZFxuICAgICk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCByZXF1ZXN0Qm9keTogYW55ID0ge1xuICAgICAgICAgICAgbW9kZWwsXG4gICAgICAgICAgICBwcm9tcHQsXG4gICAgICAgICAgICBzdHJlYW06IHRydWUsXG4gICAgICAgICAgICBvcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgdGVtcGVyYXR1cmU6IHlhbWxDb25maWcudGVtcGVyYXR1cmUsXG4gICAgICAgICAgICAgICAgbnVtX3ByZWRpY3Q6IHlhbWxDb25maWcubWF4X3Rva2VucyxcbiAgICAgICAgICAgICAgICBzdG9wOiB5YW1sQ29uZmlnLnN0b3Bfc2VxdWVuY2VzLFxuICAgICAgICAgICAgICAgIHRvcF9wOiB5YW1sQ29uZmlnLnRvcF9wLFxuICAgICAgICAgICAgICAgIGZyZXF1ZW5jeV9wZW5hbHR5OiB5YW1sQ29uZmlnLmZyZXF1ZW5jeV9wZW5hbHR5LFxuICAgICAgICAgICAgICAgIHByZXNlbmNlX3BlbmFsdHk6IHlhbWxDb25maWcucHJlc2VuY2VfcGVuYWx0eVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIENsZWFuIHVwIHVuZGVmaW5lZCBvcHRpb25zXG4gICAgICAgIE9iamVjdC5rZXlzKHJlcXVlc3RCb2R5Lm9wdGlvbnMpLmZvckVhY2goa2V5ID0+XG4gICAgICAgICAgICByZXF1ZXN0Qm9keS5vcHRpb25zW2tleV0gPT09IHVuZGVmaW5lZCAmJiBkZWxldGUgcmVxdWVzdEJvZHkub3B0aW9uc1trZXldXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHt0aGlzLnNldHRpbmdzLnNlcnZlclVybH0vYXBpL2dlbmVyYXRlYCwge1xuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSxcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHJlcXVlc3RCb2R5KSxcbiAgICAgICAgICAgIHNpZ25hbDogYWJvcnRDb250cm9sbGVyLnNpZ25hbFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE9sbGFtYSBBUEkgZXJyb3I6ICR7cmVzcG9uc2Uuc3RhdHVzfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVhZGVyID0gcmVzcG9uc2UuYm9keT8uZ2V0UmVhZGVyKCk7XG4gICAgICAgIGlmICghcmVhZGVyKSB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZWFkIHJlc3BvbnNlIGJvZHknKTtcblxuICAgICAgICBjb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7XG4gICAgICAgIGxldCBidWZmZXIgPSAnJztcblxuICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgY29uc3QgeyBkb25lLCB2YWx1ZSB9ID0gYXdhaXQgcmVhZGVyLnJlYWQoKTtcbiAgICAgICAgICAgIGlmIChkb25lKSBicmVhaztcblxuICAgICAgICAgICAgYnVmZmVyICs9IGRlY29kZXIuZGVjb2RlKHZhbHVlLCB7IHN0cmVhbTogdHJ1ZSB9KTtcbiAgICAgICAgICAgIGNvbnN0IGxpbmVzID0gYnVmZmVyLnNwbGl0KCdcXG4nKTtcbiAgICAgICAgICAgIGJ1ZmZlciA9IGxpbmVzLnBvcCgpIHx8ICcnO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcbiAgICAgICAgICAgICAgICBpZiAobGluZS50cmltKCkgPT09ICcnKSBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShsaW5lKSBhcyBPbGxhbWFHZW5lcmF0ZVJlc3BvbnNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5yZXNwb25zZSkgb25DaHVuayhkYXRhLnJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuZG9uZSkgb25Eb25lKGRhdGEpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgcGFyc2luZyBKU09OIGxpbmU6JywgbGluZSwgZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuIl19