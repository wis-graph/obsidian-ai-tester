import { requestUrl } from 'obsidian';
export class OllamaProvider {
    constructor(settings) {
        this.id = 'ollama';
        this.name = 'Ollama';
        this.settings = settings;
    }
    async fetchModels() {
        try {
            const response = await requestUrl({
                url: `${this.settings.serverUrl}/api/tags`,
                method: 'GET'
            });
            if (response.status !== 200) {
                throw new Error(`Failed to fetch models: ${response.status}`);
            }
            const ollamaRes = response.json;
            return {
                models: ollamaRes.models.map(m => ({
                    id: m.name,
                    name: m.name
                }))
            };
        }
        catch (error) {
            console.error('Error fetching models from Ollama:', error);
            throw error;
        }
    }
    async streamResponse(prompt, model, config, abortController, onChunk, onDone) {
        var _a;
        const requestBody = {
            model,
            prompt,
            stream: true,
            options: {
                temperature: config.temperature,
                num_predict: config.max_tokens,
                stop: config.stop_sequences,
                top_p: config.top_p,
                frequency_penalty: config.frequency_penalty,
                presence_penalty: config.presence_penalty
            }
        };
        // Clean up undefined options
        Object.keys(requestBody.options).forEach(key => requestBody.options[key] === undefined && delete requestBody.options[key]);
        const response = await fetch(`${this.settings.serverUrl}/api/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody),
            signal: abortController.signal
        });
        if (!response.ok) {
            throw new Error(`Ollama API error: ${response.status}`);
        }
        const reader = (_a = response.body) === null || _a === void 0 ? void 0 : _a.getReader();
        if (!reader)
            throw new Error('Failed to read response body');
        const decoder = new TextDecoder();
        let buffer = '';
        while (true) {
            const { done, value } = await reader.read();
            if (done)
                break;
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            for (const line of lines) {
                if (line.trim() === '')
                    continue;
                try {
                    const data = JSON.parse(line);
                    if (data.response)
                        onChunk(data.response);
                    if (data.done) {
                        onDone({
                            response: data.response,
                            done: true,
                            model: data.model,
                            total_duration: data.total_duration,
                            prompt_eval_count: data.prompt_eval_count,
                            eval_count: data.eval_count
                        });
                    }
                }
                catch (e) {
                    console.error('Error parsing JSON line:', line, e);
                }
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2xsYW1hUHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJPbGxhbWFQcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBSXRDLE1BQU0sT0FBTyxjQUFjO0lBS3ZCLFlBQVksUUFBd0I7UUFKcEMsT0FBRSxHQUFHLFFBQVEsQ0FBQztRQUNkLFNBQUksR0FBRyxRQUFRLENBQUM7UUFJWixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUM3QixDQUFDO0lBRUQsS0FBSyxDQUFDLFdBQVc7UUFDYixJQUFJLENBQUM7WUFDRCxNQUFNLFFBQVEsR0FBRyxNQUFNLFVBQVUsQ0FBQztnQkFDOUIsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLFdBQVc7Z0JBQzFDLE1BQU0sRUFBRSxLQUFLO2FBQ2hCLENBQUMsQ0FBQztZQUVILElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQztnQkFDMUIsTUFBTSxJQUFJLEtBQUssQ0FBQywyQkFBMkIsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFDbEUsQ0FBQztZQUVELE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxJQUEwQixDQUFDO1lBQ3RELE9BQU87Z0JBQ0gsTUFBTSxFQUFFLFNBQVMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztvQkFDL0IsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJO29CQUNWLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSTtpQkFDZixDQUFDLENBQUM7YUFDTixDQUFDO1FBQ04sQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzNELE1BQU0sS0FBSyxDQUFDO1FBQ2hCLENBQUM7SUFD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akIsY0FBYyxFQUFFLElBQUksQ0FBQyxjQUFjOzRCQUNuQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsaUJBQWlCOzRCQUN6QyxVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7eUJBQzlCLENBQUMsQ0FBQztvQkFDUCxDQUFDO2dCQUNMLENBQUM7Z0JBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztvQkFDVCxPQUFPLENBQUMsS0FBSyxDQUFDLDBCQUEwQixFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDdkQsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVxdWVzdFVybCB9IGZyb20gJ29ic2lkaWFuJztcbmltcG9ydCB7IExMTVByb3ZpZGVyIH0gZnJvbSAnLi9MTE1Qcm92aWRlcic7XG5pbXBvcnQgeyBMTE1MaXN0UmVzcG9uc2UsIExMTUdlbmVyYXRlUmVzcG9uc2UsIExMTUJsb2NrQ29uZmlnLCBPbGxhbWFTZXR0aW5ncywgT2xsYW1hTGlzdFJlc3BvbnNlIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuXG5leHBvcnQgY2xhc3MgT2xsYW1hUHJvdmlkZXIgaW1wbGVtZW50cyBMTE1Qcm92aWRlciB7XG4gICAgaWQgPSAnb2xsYW1hJztcbiAgICBuYW1lID0gJ09sbGFtYSc7XG4gICAgcHJpdmF0ZSBzZXR0aW5nczogT2xsYW1hU2V0dGluZ3M7XG5cbiAgICBjb25zdHJ1Y3RvcihzZXR0aW5nczogT2xsYW1hU2V0dGluZ3MpIHtcbiAgICAgICAgdGhpcy5zZXR0aW5ncyA9IHNldHRpbmdzO1xuICAgIH1cblxuICAgIGFzeW5jIGZldGNoTW9kZWxzKCk6IFByb21pc2U8TExNTGlzdFJlc3BvbnNlPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3RVcmwoe1xuICAgICAgICAgICAgICAgIHVybDogYCR7dGhpcy5zZXR0aW5ncy5zZXJ2ZXJVcmx9L2FwaS90YWdzYCxcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdHRVQnXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZmV0Y2ggbW9kZWxzOiAke3Jlc3BvbnNlLnN0YXR1c31gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3Qgb2xsYW1hUmVzID0gcmVzcG9uc2UuanNvbiBhcyBPbGxhbWFMaXN0UmVzcG9uc2U7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIG1vZGVsczogb2xsYW1hUmVzLm1vZGVscy5tYXAobSA9PiAoe1xuICAgICAgICAgICAgICAgICAgICBpZDogbS5uYW1lLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBtLm5hbWVcbiAgICAgICAgICAgICAgICB9KSlcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyBtb2RlbHMgZnJvbSBPbGxhbWE6JywgZXJyb3IpO1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBzdHJlYW1SZXNwb25zZShcbiAgICAgICAgcHJvbXB0OiBzdHJpbmcsXG4gICAgICAgIG1vZGVsOiBzdHJpbmcsXG4gICAgICAgIGNvbmZpZzogTExNQmxvY2tDb25maWcsXG4gICAgICAgIGFib3J0Q29udHJvbGxlcjogQWJvcnRDb250cm9sbGVyLFxuICAgICAgICBvbkNodW5rOiAoY2h1bms6IHN0cmluZykgPT4gdm9pZCxcbiAgICAgICAgb25Eb25lOiAoZmluYWxEYXRhOiBMTE1HZW5lcmF0ZVJlc3BvbnNlKSA9PiB2b2lkXG4gICAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RCb2R5OiBhbnkgPSB7XG4gICAgICAgICAgICBtb2RlbCxcbiAgICAgICAgICAgIHByb21wdCxcbiAgICAgICAgICAgIHN0cmVhbTogdHJ1ZSxcbiAgICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICB0ZW1wZXJhdHVyZTogY29uZmlnLnRlbXBlcmF0dXJlLFxuICAgICAgICAgICAgICAgIG51bV9wcmVkaWN0OiBjb25maWcubWF4X3Rva2VucyxcbiAgICAgICAgICAgICAgICBzdG9wOiBjb25maWcuc3RvcF9zZXF1ZW5jZXMsXG4gICAgICAgICAgICAgICAgdG9wX3A6IGNvbmZpZy50b3BfcCxcbiAgICAgICAgICAgICAgICBmcmVxdWVuY3lfcGVuYWx0eTogY29uZmlnLmZyZXF1ZW5jeV9wZW5hbHR5LFxuICAgICAgICAgICAgICAgIHByZXNlbmNlX3BlbmFsdHk6IGNvbmZpZy5wcmVzZW5jZV9wZW5hbHR5XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gQ2xlYW4gdXAgdW5kZWZpbmVkIG9wdGlvbnNcbiAgICAgICAgT2JqZWN0LmtleXMocmVxdWVzdEJvZHkub3B0aW9ucykuZm9yRWFjaChrZXkgPT5cbiAgICAgICAgICAgIHJlcXVlc3RCb2R5Lm9wdGlvbnNba2V5XSA9PT0gdW5kZWZpbmVkICYmIGRlbGV0ZSByZXF1ZXN0Qm9keS5vcHRpb25zW2tleV1cbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGAke3RoaXMuc2V0dGluZ3Muc2VydmVyVXJsfS9hcGkvZ2VuZXJhdGVgLCB7XG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIGhlYWRlcnM6IHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9LFxuICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVxdWVzdEJvZHkpLFxuICAgICAgICAgICAgc2lnbmFsOiBhYm9ydENvbnRyb2xsZXIuc2lnbmFsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgT2xsYW1hIEFQSSBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXN9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZWFkZXIgPSByZXNwb25zZS5ib2R5Py5nZXRSZWFkZXIoKTtcbiAgICAgICAgaWYgKCFyZWFkZXIpIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJlYWQgcmVzcG9uc2UgYm9keScpO1xuXG4gICAgICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTtcbiAgICAgICAgbGV0IGJ1ZmZlciA9ICcnO1xuXG4gICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICBjb25zdCB7IGRvbmUsIHZhbHVlIH0gPSBhd2FpdCByZWFkZXIucmVhZCgpO1xuICAgICAgICAgICAgaWYgKGRvbmUpIGJyZWFrO1xuXG4gICAgICAgICAgICBidWZmZXIgKz0gZGVjb2Rlci5kZWNvZGUodmFsdWUsIHsgc3RyZWFtOiB0cnVlIH0pO1xuICAgICAgICAgICAgY29uc3QgbGluZXMgPSBidWZmZXIuc3BsaXQoJ1xcbicpO1xuICAgICAgICAgICAgYnVmZmVyID0gbGluZXMucG9wKCkgfHwgJyc7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuICAgICAgICAgICAgICAgIGlmIChsaW5lLnRyaW0oKSA9PT0gJycpIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKGxpbmUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5yZXNwb25zZSkgb25DaHVuayhkYXRhLnJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuZG9uZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb25Eb25lKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZTogZGF0YS5yZXNwb25zZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsOiBkYXRhLm1vZGVsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsX2R1cmF0aW9uOiBkYXRhLnRvdGFsX2R1cmF0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21wdF9ldmFsX2NvdW50OiBkYXRhLnByb21wdF9ldmFsX2NvdW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2YWxfY291bnQ6IGRhdGEuZXZhbF9jb3VudFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHBhcnNpbmcgSlNPTiBsaW5lOicsIGxpbmUsIGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==