export class OpenAIProvider {
    constructor(settings) {
        this.id = 'openai';
        this.name = 'OpenAI';
        this.settings = settings;
    }
    async fetchModels() {
        if (!this.settings.apiKey) {
            // Return some common models if API key is missing to avoid empty UI
            return {
                models: [
                    { id: 'gpt-4o', name: 'GPT-4o' },
                    { id: 'gpt-4o-mini', name: 'GPT-4o mini' },
                    { id: 'gpt-4-turbo', name: 'GPT-4 Turbo' },
                    { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo' }
                ]
            };
        }
        try {
            const response = await fetch(`${this.settings.baseUrl}/models`, {
                headers: {
                    'Authorization': `Bearer ${this.settings.apiKey}`
                }
            });
            if (!response.ok) {
                throw new Error(`Failed to fetch models: ${response.status}`);
            }
            const data = await response.json();
            return {
                models: data.data
                    .filter((m) => m.id.startsWith('gpt-'))
                    .map((m) => ({
                    id: m.id,
                    name: m.id
                }))
            };
        }
        catch (error) {
            console.error('Error fetching models from OpenAI:', error);
            return { models: [{ id: 'gpt-4o', name: 'GPT-4o' }] };
        }
    }
    async streamResponse(prompt, model, config, abortController, onChunk, onDone) {
        var _a, _b, _c, _d, _e;
        const startTime = Date.now();
        const requestBody = {
            model: model || this.settings.model,
            messages: [{ role: 'user', content: prompt }],
            stream: true,
            stream_options: { include_usage: true },
            temperature: config.temperature,
            max_tokens: config.max_tokens,
            stop: config.stop_sequences,
            top_p: config.top_p,
            frequency_penalty: config.frequency_penalty,
            presence_penalty: config.presence_penalty
        };
        const response = await fetch(`${this.settings.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.settings.apiKey}`
            },
            body: JSON.stringify(requestBody),
            signal: abortController.signal
        });
        if (!response.ok) {
            const err = await response.json();
            throw new Error(`OpenAI API error: ${((_a = err.error) === null || _a === void 0 ? void 0 : _a.message) || response.statusText}`);
        }
        const reader = (_b = response.body) === null || _b === void 0 ? void 0 : _b.getReader();
        if (!reader)
            throw new Error('Failed to read response body');
        const decoder = new TextDecoder();
        let buffer = '';
        while (true) {
            const { done, value } = await reader.read();
            if (done)
                break;
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine || trimmedLine === 'data: [DONE]')
                    continue;
                if (trimmedLine.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(trimmedLine.slice(6));
                        // Handle usage chunk
                        if (data.usage) {
                            onDone({
                                response: '',
                                done: true,
                                model: model,
                                prompt_eval_count: data.usage.prompt_tokens,
                                eval_count: data.usage.completion_tokens,
                                total_duration: (Date.now() - startTime) * 1e6 // Convert to ns to match Ollama
                            });
                            continue;
                        }
                        const content = (_d = (_c = data.choices[0]) === null || _c === void 0 ? void 0 : _c.delta) === null || _d === void 0 ? void 0 : _d.content;
                        if (content)
                            onChunk(content);
                        // finish_reason might come before usage
                        if (((_e = data.choices[0]) === null || _e === void 0 ? void 0 : _e.finish_reason) && !data.usage) {
                            onDone({
                                response: '',
                                done: true,
                                model: data.model || model,
                                total_duration: (Date.now() - startTime) * 1e6
                            });
                        }
                    }
                    catch (e) {
                        console.error('Error parsing OpenAI stream chunk:', trimmedLine, e);
                    }
                }
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT3BlbkFJUHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJPcGVuQUlQcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxNQUFNLE9BQU8sY0FBYztJQUt2QixZQUFZLFFBQXdCO1FBSnBDLE9BQUUsR0FBRyxRQUFRLENBQUM7UUFDZCxTQUFJLEdBQUcsUUFBUSxDQUFDO1FBSVosSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7SUFDN0IsQ0FBQztJQUVELEtBQUssQ0FBQyxXQUFXO1FBQ2IsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDeEIsb0VBQW9FO1lBQ3BFLE9BQU87Z0JBQ0gsTUFBTSxFQUFFO29CQUNKLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO29CQUNoQyxFQUFFLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRTtvQkFDMUMsRUFBRSxFQUFFLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUU7b0JBQzFDLEVBQUUsRUFBRSxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFFO2lCQUNqRDthQUNKLENBQUM7UUFDTixDQUFDO1FBRUQsSUFBSSxDQUFDO1lBQ0QsTUFBTSxRQUFRLEdBQUcsTUFBTSxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sU0FBUyxFQUFFO2dCQUM1RCxPQUFPLEVBQUU7b0JBQ0wsZUFBZSxFQUFFLFVBQVUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUU7aUJBQ3BEO2FBQ0osQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDZixNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUNsRSxDQUFDO1lBRUQsTUFBTSxJQUFJLEdB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QUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsMENBQUUsS0FBSywwQ0FBRSxPQUFPLENBQUM7d0JBQ2hELElBQUksT0FBTzs0QkFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7d0JBRTlCLHdDQUF3Qzt3QkFDeEMsSUFBSSxDQUFBLE1BQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsMENBQUUsYUFBYSxLQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDOzRCQUNoRCxNQUFNLENBQUM7Z0NBQ0gsUUFBUSxFQUFFLEVBQUU7Z0NBQ1osSUFBSSxFQUFFLElBQUk7Z0NBQ1YsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLElBQUksS0FBSztnQ0FDMUIsY0FBYyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFNBQVMsQ0FBQyxHQUFHLEdBQUc7NkJBQ2pELENBQUMsQ0FBQzt3QkFDUCxDQUFDO29CQUNMLENBQUM7b0JBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQzt3QkFDVCxPQUFPLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDeEUsQ0FBQztnQkFDTCxDQUFDO1lBQ0wsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMTE1Qcm92aWRlciB9IGZyb20gJy4vTExNUHJvdmlkZXInO1xuaW1wb3J0IHsgTExNTGlzdFJlc3BvbnNlLCBMTE1HZW5lcmF0ZVJlc3BvbnNlLCBMTE1CbG9ja0NvbmZpZywgT3BlbkFJU2V0dGluZ3MgfSBmcm9tICcuLi8uLi90eXBlcyc7XG5cbmV4cG9ydCBjbGFzcyBPcGVuQUlQcm92aWRlciBpbXBsZW1lbnRzIExMTVByb3ZpZGVyIHtcbiAgICBpZCA9ICdvcGVuYWknO1xuICAgIG5hbWUgPSAnT3BlbkFJJztcbiAgICBwcml2YXRlIHNldHRpbmdzOiBPcGVuQUlTZXR0aW5ncztcblxuICAgIGNvbnN0cnVjdG9yKHNldHRpbmdzOiBPcGVuQUlTZXR0aW5ncykge1xuICAgICAgICB0aGlzLnNldHRpbmdzID0gc2V0dGluZ3M7XG4gICAgfVxuXG4gICAgYXN5bmMgZmV0Y2hNb2RlbHMoKTogUHJvbWlzZTxMTE1MaXN0UmVzcG9uc2U+IHtcbiAgICAgICAgaWYgKCF0aGlzLnNldHRpbmdzLmFwaUtleSkge1xuICAgICAgICAgICAgLy8gUmV0dXJuIHNvbWUgY29tbW9uIG1vZGVscyBpZiBBUEkga2V5IGlzIG1pc3NpbmcgdG8gYXZvaWQgZW1wdHkgVUlcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgbW9kZWxzOiBbXG4gICAgICAgICAgICAgICAgICAgIHsgaWQ6ICdncHQtNG8nLCBuYW1lOiAnR1BULTRvJyB9LFxuICAgICAgICAgICAgICAgICAgICB7IGlkOiAnZ3B0LTRvLW1pbmknLCBuYW1lOiAnR1BULTRvIG1pbmknIH0sXG4gICAgICAgICAgICAgICAgICAgIHsgaWQ6ICdncHQtNC10dXJibycsIG5hbWU6ICdHUFQtNCBUdXJibycgfSxcbiAgICAgICAgICAgICAgICAgICAgeyBpZDogJ2dwdC0zLjUtdHVyYm8nLCBuYW1lOiAnR1BULTMuNSBUdXJibycgfVxuICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHt0aGlzLnNldHRpbmdzLmJhc2VVcmx9L21vZGVsc2AsIHtcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke3RoaXMuc2V0dGluZ3MuYXBpS2V5fWBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGZldGNoIG1vZGVsczogJHtyZXNwb25zZS5zdGF0dXN9YCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIG1vZGVsczogZGF0YS5kYXRhXG4gICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKG06IGFueSkgPT4gbS5pZC5zdGFydHNXaXRoKCdncHQtJykpXG4gICAgICAgICAgICAgICAgICAgIC5tYXAoKG06IGFueSkgPT4gKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBtLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbS5pZFxuICAgICAgICAgICAgICAgICAgICB9KSlcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyBtb2RlbHMgZnJvbSBPcGVuQUk6JywgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIHsgbW9kZWxzOiBbeyBpZDogJ2dwdC00bycsIG5hbWU6ICdHUFQtNG8nIH1dIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBzdHJlYW1SZXNwb25zZShcbiAgICAgICAgcHJvbXB0OiBzdHJpbmcsXG4gICAgICAgIG1vZGVsOiBzdHJpbmcsXG4gICAgICAgIGNvbmZpZzogTExNQmxvY2tDb25maWcsXG4gICAgICAgIGFib3J0Q29udHJvbGxlcjogQWJvcnRDb250cm9sbGVyLFxuICAgICAgICBvbkNodW5rOiAoY2h1bms6IHN0cmluZykgPT4gdm9pZCxcbiAgICAgICAgb25Eb25lOiAoZmluYWxEYXRhOiBMTE1HZW5lcmF0ZVJlc3BvbnNlKSA9PiB2b2lkXG4gICAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RCb2R5ID0ge1xuICAgICAgICAgICAgbW9kZWw6IG1vZGVsIHx8IHRoaXMuc2V0dGluZ3MubW9kZWwsXG4gICAgICAgICAgICBtZXNzYWdlczogW3sgcm9sZTogJ3VzZXInLCBjb250ZW50OiBwcm9tcHQgfV0sXG4gICAgICAgICAgICBzdHJlYW06IHRydWUsXG4gICAgICAgICAgICBzdHJlYW1fb3B0aW9uczogeyBpbmNsdWRlX3VzYWdlOiB0cnVlIH0sXG4gICAgICAgICAgICB0ZW1wZXJhdHVyZTogY29uZmlnLnRlbXBlcmF0dXJlLFxuICAgICAgICAgICAgbWF4X3Rva2VuczogY29uZmlnLm1heF90b2tlbnMsXG4gICAgICAgICAgICBzdG9wOiBjb25maWcuc3RvcF9zZXF1ZW5jZXMsXG4gICAgICAgICAgICB0b3BfcDogY29uZmlnLnRvcF9wLFxuICAgICAgICAgICAgZnJlcXVlbmN5X3BlbmFsdHk6IGNvbmZpZy5mcmVxdWVuY3lfcGVuYWx0eSxcbiAgICAgICAgICAgIHByZXNlbmNlX3BlbmFsdHk6IGNvbmZpZy5wcmVzZW5jZV9wZW5hbHR5XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHt0aGlzLnNldHRpbmdzLmJhc2VVcmx9L2NoYXQvY29tcGxldGlvbnNgLCB7XG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke3RoaXMuc2V0dGluZ3MuYXBpS2V5fWBcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXF1ZXN0Qm9keSksXG4gICAgICAgICAgICBzaWduYWw6IGFib3J0Q29udHJvbGxlci5zaWduYWxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICAgICAgY29uc3QgZXJyID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcGVuQUkgQVBJIGVycm9yOiAke2Vyci5lcnJvcj8ubWVzc2FnZSB8fCByZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVhZGVyID0gcmVzcG9uc2UuYm9keT8uZ2V0UmVhZGVyKCk7XG4gICAgICAgIGlmICghcmVhZGVyKSB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZWFkIHJlc3BvbnNlIGJvZHknKTtcblxuICAgICAgICBjb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7XG4gICAgICAgIGxldCBidWZmZXIgPSAnJztcblxuICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgY29uc3QgeyBkb25lLCB2YWx1ZSB9ID0gYXdhaXQgcmVhZGVyLnJlYWQoKTtcbiAgICAgICAgICAgIGlmIChkb25lKSBicmVhaztcblxuICAgICAgICAgICAgYnVmZmVyICs9IGRlY29kZXIuZGVjb2RlKHZhbHVlLCB7IHN0cmVhbTogdHJ1ZSB9KTtcbiAgICAgICAgICAgIGNvbnN0IGxpbmVzID0gYnVmZmVyLnNwbGl0KCdcXG4nKTtcbiAgICAgICAgICAgIGJ1ZmZlciA9IGxpbmVzLnBvcCgpIHx8ICcnO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0cmltbWVkTGluZSA9IGxpbmUudHJpbSgpO1xuICAgICAgICAgICAgICAgIGlmICghdHJpbW1lZExpbmUgfHwgdHJpbW1lZExpbmUgPT09ICdkYXRhOiBbRE9ORV0nKSBjb250aW51ZTtcblxuICAgICAgICAgICAgICAgIGlmICh0cmltbWVkTGluZS5zdGFydHNXaXRoKCdkYXRhOiAnKSkge1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UodHJpbW1lZExpbmUuc2xpY2UoNikpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgdXNhZ2UgY2h1bmtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLnVzYWdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25Eb25lKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2U6ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbDogbW9kZWwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21wdF9ldmFsX2NvdW50OiBkYXRhLnVzYWdlLnByb21wdF90b2tlbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2YWxfY291bnQ6IGRhdGEudXNhZ2UuY29tcGxldGlvbl90b2tlbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsX2R1cmF0aW9uOiAoRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSkgKiAxZTYgLy8gQ29udmVydCB0byBucyB0byBtYXRjaCBPbGxhbWFcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udGVudCA9IGRhdGEuY2hvaWNlc1swXT8uZGVsdGE/LmNvbnRlbnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udGVudCkgb25DaHVuayhjb250ZW50KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmluaXNoX3JlYXNvbiBtaWdodCBjb21lIGJlZm9yZSB1c2FnZVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuY2hvaWNlc1swXT8uZmluaXNoX3JlYXNvbiAmJiAhZGF0YS51c2FnZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uRG9uZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlOiAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWw6IGRhdGEubW9kZWwgfHwgbW9kZWwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsX2R1cmF0aW9uOiAoRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSkgKiAxZTZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgcGFyc2luZyBPcGVuQUkgc3RyZWFtIGNodW5rOicsIHRyaW1tZWRMaW5lLCBlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==