import { Notice, setIcon } from 'obsidian';
export class OllamaBlockView {
    constructor(el, service, manager, ctx, blockSettings) {
        this.components = {};
        this.el = el;
        this.service = service;
        this.manager = manager;
        this.ctx = ctx;
        this.blockSettings = blockSettings;
    }
    render() {
        this.el.empty();
        this.createLayout();
        this.initializeController();
    }
    createLayout() {
        const container = this.el.createDiv({ cls: 'ollama-container' });
        container.style.cssText = 'padding: 12px; background: var(--background-secondary); border-radius: 8px; margin: 10px 0;';
        const headerRow = container.createDiv({ cls: 'ollama-header' });
        headerRow.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;';
        headerRow.createEl('label', { text: 'Prompt:', cls: 'setting-item-name' }).style.cssText = 'font-weight: 600; margin-right: 16px;';
        const controlsRow = headerRow.createDiv({ cls: 'ollama-controls' });
        controlsRow.style.cssText = 'display: flex; align-items: center; gap: 16px;';
        const modelLabel = controlsRow.createEl('label', { text: 'Model:', cls: 'setting-item-name' });
        modelLabel.style.cssText = 'font-size: var(--font-smaller); font-weight: 500;';
        const modelDropdown = controlsRow.createEl('select', { cls: 'ollama-model-dropdown dropdown' });
        modelDropdown.style.cssText = 'padding: 4px 32px 4px 12px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); color: var(--text-normal); font-size: var(--font-smaller); line-height: 1.5; cursor: pointer; min-width: 160px; width: fit-content; max-width: 400px; height: auto;';
        let advancedButton = null;
        let configTextarea = null;
        let configDisplay = null;
        if (this.blockSettings.hasYaml) {
            advancedButton = controlsRow.createEl('button', { cls: 'ollama-advanced-button' });
            setIcon(advancedButton, 'settings');
            advancedButton.style.cssText = 'padding: 4px; border: none; border-radius: 4px; cursor: pointer; background: transparent; display: flex; align-items: center; justify-content: center;';
            advancedButton.title = 'Advanced Settings';
            configDisplay = container.createDiv({ cls: 'ollama-config-display' });
            configDisplay.style.cssText = 'display: none; background: var(--background-primary); border: 1px solid var(--background-modifier-border); border-radius: 4px; padding: 12px; margin-bottom: 12px; font-size: var(--font-smaller);';
            configTextarea = configDisplay.createEl('textarea', { attr: { rows: 8, placeholder: 'YAML configuration...' } });
            configTextarea.style.cssText = 'width: 100%; padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); color: var(--text-normal); resize: vertical; font-family: var(--font-monospace); font-size: var(--font-smaller);';
            configTextarea.value = this.manager.generateYamlFromConfig(this.blockSettings.yamlConfig);
        }
        const promptContainer = container.createDiv({ cls: 'ollama-prompt-container' });
        promptContainer.style.cssText = 'position: relative; width: 100%; margin-bottom: 12px;';
        const promptInput = promptContainer.createEl('div', { cls: 'ollama-prompt-input', attr: { contenteditable: 'true', 'data-placeholder': 'Enter prompt... (Ctrl+Enter)' } });
        promptInput.innerHTML = this.blockSettings.prompt;
        promptInput.style.cssText = 'width: 100%; padding: 8px; padding-bottom: 30px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); color: var(--text-normal); overflow: auto; min-height: 80px; white-space: pre-wrap; word-wrap: break-word;';
        const copyButton = promptContainer.createEl('button', { cls: 'ollama-copy-button' });
        setIcon(copyButton, 'copy');
        copyButton.style.cssText = 'position: absolute; bottom: 8px; right: 8px; padding: 4px; border: none; border-radius: 4px; cursor: pointer; background: transparent; opacity: 0.6; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center;';
        copyButton.title = 'Copy prompt';
        copyButton.addEventListener('mouseenter', () => copyButton.style.opacity = '1');
        copyButton.addEventListener('mouseleave', () => copyButton.style.opacity = '0.6');
        const buttonContainer = container.createDiv({ cls: 'ollama-button-container' });
        buttonContainer.style.cssText = 'display: flex; gap: 10px; align-items: center; justify-content: flex-start;';
        const submitButton = buttonContainer.createEl('button', { text: 'Generate', cls: 'mod-cta' });
        submitButton.style.cssText = 'padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;';
        const cancelButton = buttonContainer.createEl('button', { text: 'Stop', cls: 'mod-warning' });
        cancelButton.style.cssText = 'padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: none;';
        // Responses container moved to buttonContainer
        const responsesContainer = buttonContainer.createDiv({ cls: 'ollama-responses-control' });
        responsesContainer.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-left: auto;';
        responsesContainer.createEl('label', { text: 'Responses:', cls: 'setting-item-name' }).style.cssText = 'font-size: var(--font-smaller);';
        const initialResponses = this.blockSettings.yamlConfig.num_responses || 1;
        const responsesSlider = responsesContainer.createEl('input', { cls: 'ollama-responses-slider', attr: { type: 'range', min: '1', max: '20', value: initialResponses.toString(), step: '1' } });
        responsesSlider.style.cssText = 'width: 100px; cursor: pointer;';
        const responsesInput = responsesContainer.createEl('input', { cls: 'ollama-responses-input', attr: { type: 'number', min: '1', max: '20', value: initialResponses.toString() } });
        responsesInput.style.cssText = 'width: 50px; padding: 4px 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); color: var(--text-normal); font-size: var(--font-smaller);';
        const responsesWrapper = container.createDiv({ cls: 'ollama-responses-wrapper' });
        responsesWrapper.style.cssText = 'margin-top: 12px; display: none; flex-direction: column; gap: 8px;';
        this.components = { modelDropdown, advancedButton, configDisplay, configTextarea, responsesSlider, responsesInput, promptInput, copyButton, submitButton, cancelButton, responsesWrapper };
    }
    initializeController() {
        const { modelDropdown, advancedButton, configDisplay, configTextarea, responsesSlider, responsesInput, promptInput, copyButton, submitButton, cancelButton, responsesWrapper } = this.components;
        let abortController = null;
        // Model population
        const populate = async () => {
            try {
                const res = await this.service.fetchModels();
                modelDropdown.innerHTML = '';
                res.models.forEach(m => {
                    modelDropdown.createEl('option', { value: m.name, text: m.name });
                });
                // Set initial value from YAML or fallback to global default
                const initialModel = this.blockSettings.yamlConfig.model || this.service.getSettings().model;
                if (initialModel) {
                    modelDropdown.value = initialModel;
                }
            }
            catch (e) {
                new Notice('Failed to load models');
            }
        };
        populate();
        const updateModelInYaml = this.debounce((modelName) => {
            this.blockSettings.yamlConfig.model = modelName;
            const newYaml = this.manager.generateYamlFromConfig(this.blockSettings.yamlConfig);
            this.manager.updateFileBlock(this.el, this.ctx, promptInput.innerText.trim(), newYaml);
            if (configTextarea)
                configTextarea.value = newYaml;
        }, 1000);
        modelDropdown.addEventListener('change', () => {
            updateModelInYaml(modelDropdown.value);
        });
        if (copyButton) {
            copyButton.addEventListener('click', async () => {
                const text = promptInput.innerText.trim();
                if (text) {
                    await navigator.clipboard.writeText(text);
                    new Notice('Prompt copied to clipboard');
                }
            });
        }
        if (advancedButton) {
            advancedButton.addEventListener('click', () => {
                const isHidden = configDisplay.style.display === 'none';
                configDisplay.style.display = isHidden ? 'block' : 'none';
                advancedButton.style.background = isHidden ? 'var(--background-modifier-active-hover)' : 'transparent';
            });
            configTextarea.addEventListener('input', this.debounce(() => {
                this.manager.updateFileBlock(this.el, this.ctx, promptInput.innerText.trim(), configTextarea.value.trim());
            }, 1000));
        }
        const updateResponseCount = this.debounce((val) => {
            this.blockSettings.yamlConfig.num_responses = val;
            const newYaml = this.manager.generateYamlFromConfig(this.blockSettings.yamlConfig);
            this.manager.updateFileBlock(this.el, this.ctx, promptInput.innerText.trim(), newYaml);
            if (configTextarea)
                configTextarea.value = newYaml;
        }, 1000);
        responsesSlider.addEventListener('input', () => {
            responsesInput.value = responsesSlider.value;
            updateResponseCount(parseInt(responsesSlider.value));
        });
        responsesInput.addEventListener('input', () => {
            responsesSlider.value = responsesInput.value;
            updateResponseCount(parseInt(responsesInput.value));
        });
        promptInput.addEventListener('input', this.debounce(() => {
            const yaml = this.blockSettings.hasYaml ? configTextarea.value : '';
            this.manager.updateFileBlock(this.el, this.ctx, promptInput.innerText.trim(), yaml);
        }, 1000));
        submitButton.addEventListener('click', async () => {
            const prompt = promptInput.innerText.trim();
            if (!prompt)
                return new Notice('Prompt empty');
            const count = parseInt(responsesInput.value) || 1;
            submitButton.disabled = true;
            submitButton.textContent = 'Generating...';
            cancelButton.style.display = 'block';
            responsesWrapper.style.display = 'flex';
            responsesWrapper.innerHTML = '';
            abortController = new AbortController();
            for (let i = 0; i < count; i++) {
                const item = responsesWrapper.createDiv({ cls: 'ollama-response-item' });
                item.style.cssText = 'background: var(--background-primary); border: 1px solid var(--background-modifier-border); border-radius: 4px; padding: 12px;';
                const content = item.createDiv();
                const outputPre = content.createEl('pre', { cls: 'ollama-output' });
                outputPre.style.cssText = 'white-space: pre-wrap; font-size: var(--font-smaller);';
                // Use the model from the dropdown (which is synced with YAML)
                const currentModel = modelDropdown.value;
                try {
                    await this.service.streamOllamaResponse(prompt, currentModel, this.blockSettings.yamlConfig, abortController, (chunk) => {
                        outputPre.textContent += chunk;
                    }, (final) => { });
                }
                catch (e) {
                    if (e.name === 'AbortError')
                        break;
                    content.createDiv({ text: `Error: ${e.message}` }).style.color = 'var(--text-error)';
                }
            }
            submitButton.disabled = false;
            submitButton.textContent = 'Generate';
            cancelButton.style.display = 'none';
        });
        cancelButton.addEventListener('click', () => abortController === null || abortController === void 0 ? void 0 : abortController.abort());
    }
    debounce(fn, wait) {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), wait);
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2xsYW1hQmxvY2tWaWV3LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiT2xsYW1hQmxvY2tWaWV3LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQWdDLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUt6RSxNQUFNLE9BQU8sZUFBZTtJQVN4QixZQUFZLEVBQWUsRUFBRSxPQUFzQixFQUFFLE9BQXFCLEVBQUUsR0FBaUMsRUFBRSxhQUFrQztRQUZ6SSxlQUFVLEdBQVEsRUFBRSxDQUFDO1FBR3pCLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDZixJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztJQUN2QyxDQUFDO0lBRUQsTUFBTTtRQUNGLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO0lBQ2hDLENBQUM7SUFFTyxZQUFZO1FBQ2hCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxFQUFFLGtCQUFrQixFQUFFLENBQUMsQ0FBQztRQUNqRSxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyw2RkFBNkYsQ0FBQztRQUV4SCxNQUFNLFNBQVMsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxFQUFFLGVBQWUsRUFBRSxDQUFDLENBQUM7UUFDaEUsU0FBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsMEZBQTBGLENBQUM7UUFDckgsU0FBUyxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsRUFBRSxJQUFJ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O29CQUNuQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRSxHQUFtQyxDQUFDLENBQUMsQ0FBQztnQkFDdkQsQ0FBQztnQkFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO29CQUNULElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxZQUFZO3dCQUFFLE1BQU07b0JBQ25DLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsbUJBQW1CLENBQUM7Z0JBQ3pGLENBQUM7WUFDTCxDQUFDO1lBRUQsWUFBWSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7WUFDOUIsWUFBWSxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUM7WUFDdEMsWUFBWSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO1FBRUgsWUFBWSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUMzRSxDQUFDO0lBRU8sUUFBUSxDQUFDLEVBQVksRUFBRSxJQUFZO1FBQ3ZDLElBQUksQ0FBTSxDQUFDO1FBQ1gsT0FBTyxDQUFDLEdBQUcsSUFBVyxFQUFFLEVBQUU7WUFDdEIsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2hCLENBQUMsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDckQsQ0FBQyxDQUFDO0lBQ04sQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTm90aWNlLCBNYXJrZG93blBvc3RQcm9jZXNzb3JDb250ZXh0LCBzZXRJY29uIH0gZnJvbSAnb2JzaWRpYW4nO1xuaW1wb3J0IHsgT2xsYW1hQmxvY2tTZXR0aW5ncyB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IE9sbGFtYVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9PbGxhbWFTZXJ2aWNlJztcbmltcG9ydCB7IEJsb2NrTWFuYWdlciB9IGZyb20gJy4uL2xvZ2ljL0Jsb2NrTWFuYWdlcic7XG5cbmV4cG9ydCBjbGFzcyBPbGxhbWFCbG9ja1ZpZXcge1xuICAgIHByaXZhdGUgZWw6IEhUTUxFbGVtZW50O1xuICAgIHByaXZhdGUgc2VydmljZTogT2xsYW1hU2VydmljZTtcbiAgICBwcml2YXRlIG1hbmFnZXI6IEJsb2NrTWFuYWdlcjtcbiAgICBwcml2YXRlIGN0eDogTWFya2Rvd25Qb3N0UHJvY2Vzc29yQ29udGV4dDtcbiAgICBwcml2YXRlIGJsb2NrU2V0dGluZ3M6IE9sbGFtYUJsb2NrU2V0dGluZ3M7XG5cbiAgICBwcml2YXRlIGNvbXBvbmVudHM6IGFueSA9IHt9O1xuXG4gICAgY29uc3RydWN0b3IoZWw6IEhUTUxFbGVtZW50LCBzZXJ2aWNlOiBPbGxhbWFTZXJ2aWNlLCBtYW5hZ2VyOiBCbG9ja01hbmFnZXIsIGN0eDogTWFya2Rvd25Qb3N0UHJvY2Vzc29yQ29udGV4dCwgYmxvY2tTZXR0aW5nczogT2xsYW1hQmxvY2tTZXR0aW5ncykge1xuICAgICAgICB0aGlzLmVsID0gZWw7XG4gICAgICAgIHRoaXMuc2VydmljZSA9IHNlcnZpY2U7XG4gICAgICAgIHRoaXMubWFuYWdlciA9IG1hbmFnZXI7XG4gICAgICAgIHRoaXMuY3R4ID0gY3R4O1xuICAgICAgICB0aGlzLmJsb2NrU2V0dGluZ3MgPSBibG9ja1NldHRpbmdzO1xuICAgIH1cblxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgdGhpcy5lbC5lbXB0eSgpO1xuICAgICAgICB0aGlzLmNyZWF0ZUxheW91dCgpO1xuICAgICAgICB0aGlzLmluaXRpYWxpemVDb250cm9sbGVyKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVMYXlvdXQoKSB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuZWwuY3JlYXRlRGl2KHsgY2xzOiAnb2xsYW1hLWNvbnRhaW5lcicgfSk7XG4gICAgICAgIGNvbnRhaW5lci5zdHlsZS5jc3NUZXh0ID0gJ3BhZGRpbmc6IDEycHg7IGJhY2tncm91bmQ6IHZhcigtLWJhY2tncm91bmQtc2Vjb25kYXJ5KTsgYm9yZGVyLXJhZGl1czogOHB4OyBtYXJnaW46IDEwcHggMDsnO1xuXG4gICAgICAgIGNvbnN0IGhlYWRlclJvdyA9IGNvbnRhaW5lci5jcmVhdGVEaXYoeyBjbHM6ICdvbGxhbWEtaGVhZGVyJyB9KTtcbiAgICAgICAgaGVhZGVyUm93LnN0eWxlLmNzc1RleHQgPSAnZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IGNlbnRlcjsganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOyBtYXJnaW4tYm90dG9tOiAxMnB4Oyc7XG4gICAgICAgIGhlYWRlclJvdy5jcmVhdGVFbCgnbGFiZWwnLCB7IHRleHQ6ICdQcm9tcHQ6JywgY2xzOiAnc2V0dGluZy1pdGVtLW5hbWUnIH0pLnN0eWxlLmNzc1RleHQgPSAnZm9udC13ZWlnaHQ6IDYwMDsgbWFyZ2luLXJpZ2h0OiAxNnB4Oyc7XG5cbiAgICAgICAgY29uc3QgY29udHJvbHNSb3cgPSBoZWFkZXJSb3cuY3JlYXRlRGl2KHsgY2xzOiAnb2xsYW1hLWNvbnRyb2xzJyB9KTtcbiAgICAgICAgY29udHJvbHNSb3cuc3R5bGUuY3NzVGV4dCA9ICdkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDE2cHg7JztcblxuICAgICAgICBjb25zdCBtb2RlbExhYmVsID0gY29udHJvbHNSb3cuY3JlYXRlRWwoJ2xhYmVsJywgeyB0ZXh0OiAnTW9kZWw6JywgY2xzOiAnc2V0dGluZy1pdGVtLW5hbWUnIH0pO1xuICAgICAgICBtb2RlbExhYmVsLnN0eWxlLmNzc1RleHQgPSAnZm9udC1zaXplOiB2YXIoLS1mb250LXNtYWxsZXIpOyBmb250LXdlaWdodDogNTAwOyc7XG5cbiAgICAgICAgY29uc3QgbW9kZWxEcm9wZG93biA9IGNvbnRyb2xzUm93LmNyZWF0ZUVsKCdzZWxlY3QnLCB7IGNsczogJ29sbGFtYS1tb2RlbC1kcm9wZG93biBkcm9wZG93bicgfSk7XG4gICAgICAgIG1vZGVsRHJvcGRvd24uc3R5bGUuY3NzVGV4dCA9ICdwYWRkaW5nOiA0cHggMzJweCA0cHggMTJweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tYmFja2dyb3VuZC1tb2RpZmllci1ib3JkZXIpOyBib3JkZXItcmFkaXVzOiA0cHg7IGJhY2tncm91bmQ6IHZhcigtLWJhY2tncm91bmQtcHJpbWFyeSk7IGNvbG9yOiB2YXIoLS10ZXh0LW5vcm1hbCk7IGZvbnQtc2l6ZTogdmFyKC0tZm9udC1zbWFsbGVyKTsgbGluZS1oZWlnaHQ6IDEuNTsgY3Vyc29yOiBwb2ludGVyOyBtaW4td2lkdGg6IDE2MHB4OyB3aWR0aDogZml0LWNvbnRlbnQ7IG1heC13aWR0aDogNDAwcHg7IGhlaWdodDogYXV0bzsnO1xuXG4gICAgICAgIGxldCBhZHZhbmNlZEJ1dHRvbjogSFRNTEJ1dHRvbkVsZW1lbnQgfCBudWxsID0gbnVsbDtcbiAgICAgICAgbGV0IGNvbmZpZ1RleHRhcmVhOiBIVE1MVGV4dEFyZWFFbGVtZW50IHwgbnVsbCA9IG51bGw7XG4gICAgICAgIGxldCBjb25maWdEaXNwbGF5OiBIVE1MRGl2RWxlbWVudCB8IG51bGwgPSBudWxsO1xuXG4gICAgICAgIGlmICh0aGlzLmJsb2NrU2V0dGluZ3MuaGFzWWFtbCkge1xuICAgICAgICAgICAgYWR2YW5jZWRCdXR0b24gPSBjb250cm9sc1Jvdy5jcmVhdGVFbCgnYnV0dG9uJywgeyBjbHM6ICdvbGxhbWEtYWR2YW5jZWQtYnV0dG9uJyB9KTtcbiAgICAgICAgICAgIHNldEljb24oYWR2YW5jZWRCdXR0b24sICdzZXR0aW5ncycpO1xuICAgICAgICAgICAgYWR2YW5jZWRCdXR0b24uc3R5bGUuY3NzVGV4dCA9ICdwYWRkaW5nOiA0cHg7IGJvcmRlcjogbm9uZTsgYm9yZGVyLXJhZGl1czogNHB4OyBjdXJzb3I6IHBvaW50ZXI7IGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OyBkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsnO1xuICAgICAgICAgICAgYWR2YW5jZWRCdXR0b24udGl0bGUgPSAnQWR2YW5jZWQgU2V0dGluZ3MnO1xuXG4gICAgICAgICAgICBjb25maWdEaXNwbGF5ID0gY29udGFpbmVyLmNyZWF0ZURpdih7IGNsczogJ29sbGFtYS1jb25maWctZGlzcGxheScgfSk7XG4gICAgICAgICAgICBjb25maWdEaXNwbGF5LnN0eWxlLmNzc1RleHQgPSAnZGlzcGxheTogbm9uZTsgYmFja2dyb3VuZDogdmFyKC0tYmFja2dyb3VuZC1wcmltYXJ5KTsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tYmFja2dyb3VuZC1tb2RpZmllci1ib3JkZXIpOyBib3JkZXItcmFkaXVzOiA0cHg7IHBhZGRpbmc6IDEycHg7IG1hcmdpbi1ib3R0b206IDEycHg7IGZvbnQtc2l6ZTogdmFyKC0tZm9udC1zbWFsbGVyKTsnO1xuXG4gICAgICAgICAgICBjb25maWdUZXh0YXJlYSA9IGNvbmZpZ0Rpc3BsYXkuY3JlYXRlRWwoJ3RleHRhcmVhJywgeyBhdHRyOiB7IHJvd3M6IDgsIHBsYWNlaG9sZGVyOiAnWUFNTCBjb25maWd1cmF0aW9uLi4uJyB9IH0pO1xuICAgICAgICAgICAgY29uZmlnVGV4dGFyZWEuc3R5bGUuY3NzVGV4dCA9ICd3aWR0aDogMTAwJTsgcGFkZGluZzogOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1iYWNrZ3JvdW5kLW1vZGlmaWVyLWJvcmRlcik7IGJvcmRlci1yYWRpdXM6IDRweDsgYmFja2dyb3VuZDogdmFyKC0tYmFja2dyb3VuZC1wcmltYXJ5KTsgY29sb3I6IHZhcigtLXRleHQtbm9ybWFsKTsgcmVzaXplOiB2ZXJ0aWNhbDsgZm9udC1mYW1pbHk6IHZhcigtLWZvbnQtbW9ub3NwYWNlKTsgZm9udC1zaXplOiB2YXIoLS1mb250LXNtYWxsZXIpOyc7XG4gICAgICAgICAgICBjb25maWdUZXh0YXJlYS52YWx1ZSA9IHRoaXMubWFuYWdlci5nZW5lcmF0ZVlhbWxGcm9tQ29uZmlnKHRoaXMuYmxvY2tTZXR0aW5ncy55YW1sQ29uZmlnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHByb21wdENvbnRhaW5lciA9IGNvbnRhaW5lci5jcmVhdGVEaXYoeyBjbHM6ICdvbGxhbWEtcHJvbXB0LWNvbnRhaW5lcicgfSk7XG4gICAgICAgIHByb21wdENvbnRhaW5lci5zdHlsZS5jc3NUZXh0ID0gJ3Bvc2l0aW9uOiByZWxhdGl2ZTsgd2lkdGg6IDEwMCU7IG1hcmdpbi1ib3R0b206IDEycHg7JztcblxuICAgICAgICBjb25zdCBwcm9tcHRJbnB1dCA9IHByb21wdENvbnRhaW5lci5jcmVhdGVFbCgnZGl2JywgeyBjbHM6ICdvbGxhbWEtcHJvbXB0LWlucHV0JywgYXR0cjogeyBjb250ZW50ZWRpdGFibGU6ICd0cnVlJywgJ2RhdGEtcGxhY2Vob2xkZXInOiAnRW50ZXIgcHJvbXB0Li4uIChDdHJsK0VudGVyKScgfSB9KTtcbiAgICAgICAgcHJvbXB0SW5wdXQuaW5uZXJIVE1MID0gdGhpcy5ibG9ja1NldHRpbmdzLnByb21wdDtcbiAgICAgICAgcHJvbXB0SW5wdXQuc3R5bGUuY3NzVGV4dCA9ICd3aWR0aDogMTAwJTsgcGFkZGluZzogOHB4OyBwYWRkaW5nLWJvdHRvbTogMzBweDsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tYmFja2dyb3VuZC1tb2RpZmllci1ib3JkZXIpOyBib3JkZXItcmFkaXVzOiA0cHg7IGJhY2tncm91bmQ6IHZhcigtLWJhY2tncm91bmQtcHJpbWFyeSk7IGNvbG9yOiB2YXIoLS10ZXh0LW5vcm1hbCk7IG92ZXJmbG93OiBhdXRvOyBtaW4taGVpZ2h0OiA4MHB4OyB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7IHdvcmQtd3JhcDogYnJlYWstd29yZDsnO1xuXG4gICAgICAgIGNvbnN0IGNvcHlCdXR0b24gPSBwcm9tcHRDb250YWluZXIuY3JlYXRlRWwoJ2J1dHRvbicsIHsgY2xzOiAnb2xsYW1hLWNvcHktYnV0dG9uJyB9KTtcbiAgICAgICAgc2V0SWNvbihjb3B5QnV0dG9uLCAnY29weScpO1xuICAgICAgICBjb3B5QnV0dG9uLnN0eWxlLmNzc1RleHQgPSAncG9zaXRpb246IGFic29sdXRlOyBib3R0b206IDhweDsgcmlnaHQ6IDhweDsgcGFkZGluZzogNHB4OyBib3JkZXI6IG5vbmU7IGJvcmRlci1yYWRpdXM6IDRweDsgY3Vyc29yOiBwb2ludGVyOyBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsgb3BhY2l0eTogMC42OyB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuMnM7IGRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiBjZW50ZXI7IGp1c3RpZnktY29udGVudDogY2VudGVyOyc7XG4gICAgICAgIGNvcHlCdXR0b24udGl0bGUgPSAnQ29weSBwcm9tcHQnO1xuICAgICAgICBjb3B5QnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZW50ZXInLCAoKSA9PiBjb3B5QnV0dG9uLnN0eWxlLm9wYWNpdHkgPSAnMScpO1xuICAgICAgICBjb3B5QnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCAoKSA9PiBjb3B5QnV0dG9uLnN0eWxlLm9wYWNpdHkgPSAnMC42Jyk7XG5cbiAgICAgICAgY29uc3QgYnV0dG9uQ29udGFpbmVyID0gY29udGFpbmVyLmNyZWF0ZURpdih7IGNsczogJ29sbGFtYS1idXR0b24tY29udGFpbmVyJyB9KTtcbiAgICAgICAgYnV0dG9uQ29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAnZGlzcGxheTogZmxleDsgZ2FwOiAxMHB4OyBhbGlnbi1pdGVtczogY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IGZsZXgtc3RhcnQ7JztcblxuICAgICAgICBjb25zdCBzdWJtaXRCdXR0b24gPSBidXR0b25Db250YWluZXIuY3JlYXRlRWwoJ2J1dHRvbicsIHsgdGV4dDogJ0dlbmVyYXRlJywgY2xzOiAnbW9kLWN0YScgfSk7XG4gICAgICAgIHN1Ym1pdEJ1dHRvbi5zdHlsZS5jc3NUZXh0ID0gJ3BhZGRpbmc6IDhweCAxNnB4OyBib3JkZXI6IG5vbmU7IGJvcmRlci1yYWRpdXM6IDRweDsgY3Vyc29yOiBwb2ludGVyOyBmb250LXdlaWdodDogNjAwOyc7XG5cbiAgICAgICAgY29uc3QgY2FuY2VsQnV0dG9uID0gYnV0dG9uQ29udGFpbmVyLmNyZWF0ZUVsKCdidXR0b24nLCB7IHRleHQ6ICdTdG9wJywgY2xzOiAnbW9kLXdhcm5pbmcnIH0pO1xuICAgICAgICBjYW5jZWxCdXR0b24uc3R5bGUuY3NzVGV4dCA9ICdwYWRkaW5nOiA4cHggMTZweDsgYm9yZGVyOiBub25lOyBib3JkZXItcmFkaXVzOiA0cHg7IGN1cnNvcjogcG9pbnRlcjsgZm9udC13ZWlnaHQ6IDYwMDsgZGlzcGxheTogbm9uZTsnO1xuXG4gICAgICAgIC8vIFJlc3BvbnNlcyBjb250YWluZXIgbW92ZWQgdG8gYnV0dG9uQ29udGFpbmVyXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlc0NvbnRhaW5lciA9IGJ1dHRvbkNvbnRhaW5lci5jcmVhdGVEaXYoeyBjbHM6ICdvbGxhbWEtcmVzcG9uc2VzLWNvbnRyb2wnIH0pO1xuICAgICAgICByZXNwb25zZXNDb250YWluZXIuc3R5bGUuY3NzVGV4dCA9ICdkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogY2VudGVyOyBnYXA6IDhweDsgbWFyZ2luLWxlZnQ6IGF1dG87JztcbiAgICAgICAgcmVzcG9uc2VzQ29udGFpbmVyLmNyZWF0ZUVsKCdsYWJlbCcsIHsgdGV4dDogJ1Jlc3BvbnNlczonLCBjbHM6ICdzZXR0aW5nLWl0ZW0tbmFtZScgfSkuc3R5bGUuY3NzVGV4dCA9ICdmb250LXNpemU6IHZhcigtLWZvbnQtc21hbGxlcik7JztcblxuICAgICAgICBjb25zdCBpbml0aWFsUmVzcG9uc2VzID0gdGhpcy5ibG9ja1NldHRpbmdzLnlhbWxDb25maWcubnVtX3Jlc3BvbnNlcyB8fCAxO1xuICAgICAgICBjb25zdCByZXNwb25zZXNTbGlkZXIgPSByZXNwb25zZXNDb250YWluZXIuY3JlYXRlRWwoJ2lucHV0JywgeyBjbHM6ICdvbGxhbWEtcmVzcG9uc2VzLXNsaWRlcicsIGF0dHI6IHsgdHlwZTogJ3JhbmdlJywgbWluOiAnMScsIG1heDogJzIwJywgdmFsdWU6IGluaXRpYWxSZXNwb25zZXMudG9TdHJpbmcoKSwgc3RlcDogJzEnIH0gfSk7XG4gICAgICAgIHJlc3BvbnNlc1NsaWRlci5zdHlsZS5jc3NUZXh0ID0gJ3dpZHRoOiAxMDBweDsgY3Vyc29yOiBwb2ludGVyOyc7XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2VzSW5wdXQgPSByZXNwb25zZXNDb250YWluZXIuY3JlYXRlRWwoJ2lucHV0JywgeyBjbHM6ICdvbGxhbWEtcmVzcG9uc2VzLWlucHV0JywgYXR0cjogeyB0eXBlOiAnbnVtYmVyJywgbWluOiAnMScsIG1heDogJzIwJywgdmFsdWU6IGluaXRpYWxSZXNwb25zZXMudG9TdHJpbmcoKSB9IH0pO1xuICAgICAgICByZXNwb25zZXNJbnB1dC5zdHlsZS5jc3NUZXh0ID0gJ3dpZHRoOiA1MHB4OyBwYWRkaW5nOiA0cHggOHB4OyBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1iYWNrZ3JvdW5kLW1vZGlmaWVyLWJvcmRlcik7IGJvcmRlci1yYWRpdXM6IDRweDsgYmFja2dyb3VuZDogdmFyKC0tYmFja2dyb3VuZC1wcmltYXJ5KTsgY29sb3I6IHZhcigtLXRleHQtbm9ybWFsKTsgZm9udC1zaXplOiB2YXIoLS1mb250LXNtYWxsZXIpOyc7XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2VzV3JhcHBlciA9IGNvbnRhaW5lci5jcmVhdGVEaXYoeyBjbHM6ICdvbGxhbWEtcmVzcG9uc2VzLXdyYXBwZXInIH0pO1xuICAgICAgICByZXNwb25zZXNXcmFwcGVyLnN0eWxlLmNzc1RleHQgPSAnbWFyZ2luLXRvcDogMTJweDsgZGlzcGxheTogbm9uZTsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsgZ2FwOiA4cHg7JztcblxuICAgICAgICB0aGlzLmNvbXBvbmVudHMgPSB7IG1vZGVsRHJvcGRvd24sIGFkdmFuY2VkQnV0dG9uLCBjb25maWdEaXNwbGF5LCBjb25maWdUZXh0YXJlYSwgcmVzcG9uc2VzU2xpZGVyLCByZXNwb25zZXNJbnB1dCwgcHJvbXB0SW5wdXQsIGNvcHlCdXR0b24sIHN1Ym1pdEJ1dHRvbiwgY2FuY2VsQnV0dG9uLCByZXNwb25zZXNXcmFwcGVyIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0aWFsaXplQ29udHJvbGxlcigpIHtcbiAgICAgICAgY29uc3QgeyBtb2RlbERyb3Bkb3duLCBhZHZhbmNlZEJ1dHRvbiwgY29uZmlnRGlzcGxheSwgY29uZmlnVGV4dGFyZWEsIHJlc3BvbnNlc1NsaWRlciwgcmVzcG9uc2VzSW5wdXQsIHByb21wdElucHV0LCBjb3B5QnV0dG9uLCBzdWJtaXRCdXR0b24sIGNhbmNlbEJ1dHRvbiwgcmVzcG9uc2VzV3JhcHBlciB9ID0gdGhpcy5jb21wb25lbnRzO1xuICAgICAgICBsZXQgYWJvcnRDb250cm9sbGVyOiBBYm9ydENvbnRyb2xsZXIgfCBudWxsID0gbnVsbDtcblxuICAgICAgICAvLyBNb2RlbCBwb3B1bGF0aW9uXG4gICAgICAgIGNvbnN0IHBvcHVsYXRlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLnNlcnZpY2UuZmV0Y2hNb2RlbHMoKTtcbiAgICAgICAgICAgICAgICBtb2RlbERyb3Bkb3duLmlubmVySFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgIHJlcy5tb2RlbHMuZm9yRWFjaChtID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbW9kZWxEcm9wZG93bi5jcmVhdGVFbCgnb3B0aW9uJywgeyB2YWx1ZTogbS5uYW1lLCB0ZXh0OiBtLm5hbWUgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAvLyBTZXQgaW5pdGlhbCB2YWx1ZSBmcm9tIFlBTUwgb3IgZmFsbGJhY2sgdG8gZ2xvYmFsIGRlZmF1bHRcbiAgICAgICAgICAgICAgICBjb25zdCBpbml0aWFsTW9kZWwgPSB0aGlzLmJsb2NrU2V0dGluZ3MueWFtbENvbmZpZy5tb2RlbCB8fCB0aGlzLnNlcnZpY2UuZ2V0U2V0dGluZ3MoKS5tb2RlbDtcbiAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbE1vZGVsKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vZGVsRHJvcGRvd24udmFsdWUgPSBpbml0aWFsTW9kZWw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyBuZXcgTm90aWNlKCdGYWlsZWQgdG8gbG9hZCBtb2RlbHMnKTsgfVxuICAgICAgICB9O1xuICAgICAgICBwb3B1bGF0ZSgpO1xuXG4gICAgICAgIGNvbnN0IHVwZGF0ZU1vZGVsSW5ZYW1sID0gdGhpcy5kZWJvdW5jZSgobW9kZWxOYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIHRoaXMuYmxvY2tTZXR0aW5ncy55YW1sQ29uZmlnLm1vZGVsID0gbW9kZWxOYW1lO1xuICAgICAgICAgICAgY29uc3QgbmV3WWFtbCA9IHRoaXMubWFuYWdlci5nZW5lcmF0ZVlhbWxGcm9tQ29uZmlnKHRoaXMuYmxvY2tTZXR0aW5ncy55YW1sQ29uZmlnKTtcbiAgICAgICAgICAgIHRoaXMubWFuYWdlci51cGRhdGVGaWxlQmxvY2sodGhpcy5lbCwgdGhpcy5jdHgsIHByb21wdElucHV0LmlubmVyVGV4dC50cmltKCksIG5ld1lhbWwpO1xuICAgICAgICAgICAgaWYgKGNvbmZpZ1RleHRhcmVhKSBjb25maWdUZXh0YXJlYS52YWx1ZSA9IG5ld1lhbWw7XG4gICAgICAgIH0sIDEwMDApO1xuXG4gICAgICAgIG1vZGVsRHJvcGRvd24uYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKCkgPT4ge1xuICAgICAgICAgICAgdXBkYXRlTW9kZWxJbllhbWwobW9kZWxEcm9wZG93bi52YWx1ZSk7XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoY29weUJ1dHRvbikge1xuICAgICAgICAgICAgY29weUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0ID0gcHJvbXB0SW5wdXQuaW5uZXJUZXh0LnRyaW0oKTtcbiAgICAgICAgICAgICAgICBpZiAodGV4dCkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCh0ZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgbmV3IE5vdGljZSgnUHJvbXB0IGNvcGllZCB0byBjbGlwYm9hcmQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYWR2YW5jZWRCdXR0b24pIHtcbiAgICAgICAgICAgIGFkdmFuY2VkQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzSGlkZGVuID0gY29uZmlnRGlzcGxheS5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZSc7XG4gICAgICAgICAgICAgICAgY29uZmlnRGlzcGxheS5zdHlsZS5kaXNwbGF5ID0gaXNIaWRkZW4gPyAnYmxvY2snIDogJ25vbmUnO1xuICAgICAgICAgICAgICAgIGFkdmFuY2VkQnV0dG9uLnN0eWxlLmJhY2tncm91bmQgPSBpc0hpZGRlbiA/ICd2YXIoLS1iYWNrZ3JvdW5kLW1vZGlmaWVyLWFjdGl2ZS1ob3ZlciknIDogJ3RyYW5zcGFyZW50JztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY29uZmlnVGV4dGFyZWEuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCB0aGlzLmRlYm91bmNlKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm1hbmFnZXIudXBkYXRlRmlsZUJsb2NrKHRoaXMuZWwsIHRoaXMuY3R4LCBwcm9tcHRJbnB1dC5pbm5lclRleHQudHJpbSgpLCBjb25maWdUZXh0YXJlYS52YWx1ZS50cmltKCkpO1xuICAgICAgICAgICAgfSwgMTAwMCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdXBkYXRlUmVzcG9uc2VDb3VudCA9IHRoaXMuZGVib3VuY2UoKHZhbDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmJsb2NrU2V0dGluZ3MueWFtbENvbmZpZy5udW1fcmVzcG9uc2VzID0gdmFsO1xuICAgICAgICAgICAgY29uc3QgbmV3WWFtbCA9IHRoaXMubWFuYWdlci5nZW5lcmF0ZVlhbWxGcm9tQ29uZmlnKHRoaXMuYmxvY2tTZXR0aW5ncy55YW1sQ29uZmlnKTtcbiAgICAgICAgICAgIHRoaXMubWFuYWdlci51cGRhdGVGaWxlQmxvY2sodGhpcy5lbCwgdGhpcy5jdHgsIHByb21wdElucHV0LmlubmVyVGV4dC50cmltKCksIG5ld1lhbWwpO1xuICAgICAgICAgICAgaWYgKGNvbmZpZ1RleHRhcmVhKSBjb25maWdUZXh0YXJlYS52YWx1ZSA9IG5ld1lhbWw7XG4gICAgICAgIH0sIDEwMDApO1xuXG4gICAgICAgIHJlc3BvbnNlc1NsaWRlci5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsICgpID0+IHtcbiAgICAgICAgICAgIHJlc3BvbnNlc0lucHV0LnZhbHVlID0gcmVzcG9uc2VzU2xpZGVyLnZhbHVlO1xuICAgICAgICAgICAgdXBkYXRlUmVzcG9uc2VDb3VudChwYXJzZUludChyZXNwb25zZXNTbGlkZXIudmFsdWUpKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJlc3BvbnNlc0lucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKCkgPT4ge1xuICAgICAgICAgICAgcmVzcG9uc2VzU2xpZGVyLnZhbHVlID0gcmVzcG9uc2VzSW5wdXQudmFsdWU7XG4gICAgICAgICAgICB1cGRhdGVSZXNwb25zZUNvdW50KHBhcnNlSW50KHJlc3BvbnNlc0lucHV0LnZhbHVlKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHByb21wdElucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgdGhpcy5kZWJvdW5jZSgoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB5YW1sID0gdGhpcy5ibG9ja1NldHRpbmdzLmhhc1lhbWwgPyBjb25maWdUZXh0YXJlYS52YWx1ZSA6ICcnO1xuICAgICAgICAgICAgdGhpcy5tYW5hZ2VyLnVwZGF0ZUZpbGVCbG9jayh0aGlzLmVsLCB0aGlzLmN0eCwgcHJvbXB0SW5wdXQuaW5uZXJUZXh0LnRyaW0oKSwgeWFtbCk7XG4gICAgICAgIH0sIDEwMDApKTtcblxuICAgICAgICBzdWJtaXRCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwcm9tcHQgPSBwcm9tcHRJbnB1dC5pbm5lclRleHQudHJpbSgpO1xuICAgICAgICAgICAgaWYgKCFwcm9tcHQpIHJldHVybiBuZXcgTm90aWNlKCdQcm9tcHQgZW1wdHknKTtcblxuICAgICAgICAgICAgY29uc3QgY291bnQgPSBwYXJzZUludChyZXNwb25zZXNJbnB1dC52YWx1ZSkgfHwgMTtcbiAgICAgICAgICAgIHN1Ym1pdEJ1dHRvbi5kaXNhYmxlZCA9IHRydWU7XG4gICAgICAgICAgICBzdWJtaXRCdXR0b24udGV4dENvbnRlbnQgPSAnR2VuZXJhdGluZy4uLic7XG4gICAgICAgICAgICBjYW5jZWxCdXR0b24uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gICAgICAgICAgICByZXNwb25zZXNXcmFwcGVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7XG4gICAgICAgICAgICByZXNwb25zZXNXcmFwcGVyLmlubmVySFRNTCA9ICcnO1xuXG4gICAgICAgICAgICBhYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSByZXNwb25zZXNXcmFwcGVyLmNyZWF0ZURpdih7IGNsczogJ29sbGFtYS1yZXNwb25zZS1pdGVtJyB9KTtcbiAgICAgICAgICAgICAgICBpdGVtLnN0eWxlLmNzc1RleHQgPSAnYmFja2dyb3VuZDogdmFyKC0tYmFja2dyb3VuZC1wcmltYXJ5KTsgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tYmFja2dyb3VuZC1tb2RpZmllci1ib3JkZXIpOyBib3JkZXItcmFkaXVzOiA0cHg7IHBhZGRpbmc6IDEycHg7JztcbiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50ID0gaXRlbS5jcmVhdGVEaXYoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBvdXRwdXRQcmUgPSBjb250ZW50LmNyZWF0ZUVsKCdwcmUnLCB7IGNsczogJ29sbGFtYS1vdXRwdXQnIH0pO1xuICAgICAgICAgICAgICAgIG91dHB1dFByZS5zdHlsZS5jc3NUZXh0ID0gJ3doaXRlLXNwYWNlOiBwcmUtd3JhcDsgZm9udC1zaXplOiB2YXIoLS1mb250LXNtYWxsZXIpOyc7XG5cbiAgICAgICAgICAgICAgICAvLyBVc2UgdGhlIG1vZGVsIGZyb20gdGhlIGRyb3Bkb3duICh3aGljaCBpcyBzeW5jZWQgd2l0aCBZQU1MKVxuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRNb2RlbCA9IG1vZGVsRHJvcGRvd24udmFsdWU7XG5cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnNlcnZpY2Uuc3RyZWFtT2xsYW1hUmVzcG9uc2UocHJvbXB0LCBjdXJyZW50TW9kZWwsIHRoaXMuYmxvY2tTZXR0aW5ncy55YW1sQ29uZmlnLCBhYm9ydENvbnRyb2xsZXIsIChjaHVuaykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0UHJlLnRleHRDb250ZW50ICs9IGNodW5rO1xuICAgICAgICAgICAgICAgICAgICB9LCAoZmluYWwpID0+IHsgLyogU3RhdHMgbG9naWMgY291bGQgZ28gaGVyZSAqLyB9KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlLm5hbWUgPT09ICdBYm9ydEVycm9yJykgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQuY3JlYXRlRGl2KHsgdGV4dDogYEVycm9yOiAke2UubWVzc2FnZX1gIH0pLnN0eWxlLmNvbG9yID0gJ3ZhcigtLXRleHQtZXJyb3IpJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHN1Ym1pdEJ1dHRvbi5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgc3VibWl0QnV0dG9uLnRleHRDb250ZW50ID0gJ0dlbmVyYXRlJztcbiAgICAgICAgICAgIGNhbmNlbEJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICB9KTtcblxuICAgICAgICBjYW5jZWxCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiBhYm9ydENvbnRyb2xsZXI/LmFib3J0KCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGVib3VuY2UoZm46IEZ1bmN0aW9uLCB3YWl0OiBudW1iZXIpIHtcbiAgICAgICAgbGV0IHQ6IGFueTtcbiAgICAgICAgcmV0dXJuICguLi5hcmdzOiBhbnlbXSkgPT4ge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHQpO1xuICAgICAgICAgICAgdCA9IHNldFRpbWVvdXQoKCkgPT4gZm4uYXBwbHkodGhpcywgYXJncyksIHdhaXQpO1xuICAgICAgICB9O1xuICAgIH1cbn1cbiJdfQ==